<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRUCE Project Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            background-color: #f0f0f0;
        }
        .sidebar {
            width: 250px;
            padding: 20px;
            background-color: #f4f4f4;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .main-content {
            margin-left: 270px;
            padding: 20px;
            width: calc(100% - 270px);
        }
        .sidebar h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }
        .sidebar label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
            color: #555;
        }
        .sidebar select, .sidebar input {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #graph {
            width: 100%;
            height: 500px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #stats {
            margin-top: 20px;
            padding: 10px;
            background-color: #e8e8e8;
            border-radius: 5px;
            color: #333;
        }
        #error-message {
            color: red;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>SPRUCE Dashboard</h2>
        <label for="plot-select">Plot:</label>
        <select id="plot-select"></select>

        <label for="co2-select">CO2 Treatment:</label>
        <select id="co2-select"></select>

        <label for="temp-select">Temp Target (°C):</label>
        <select id="temp-select"></select>

        <label for="depth-select">Soil Depth (cm):</label>
        <select id="depth-select">
            <option value="TS_0__A1">0 cm (A1)</option>
            <option value="TS_-5__A2">-5 cm (A2)</option>
            <option value="TS_-10__A3">-10 cm (A3)</option>
            <option value="TS_-20__A4">-20 cm (A4)</option>
            <option value="TS_-30__A5">-30 cm (A5)</option>
            <option value="TS_-40__A6">-40 cm (A6)</option>
            <option value="TS_-50__A7">-50 cm (A7)</option>
            <option value="TS_-100__A8">-100 cm (A8)</option>
            <option value="TS_-200__A9">-200 cm (A9)</option>
        </select>

        <label for="view-select">View:</label>
        <select id="view-select">
            <option value="scatter">Scatter</option>
            <option value="line">Line</option>
            <option value="bar">Bar</option>
        </select>

        <label for="fit-select">Fit:</label>
        <select id="fit-select">
            <option value="none">None</option>
            <option value="linear">Linear</option>
            <option value="quadratic">Quadratic</option>
        </select>

        <label for="time-range">Time Range:</label>
        <input type="text" id="time-range" placeholder="Select date range">

        <div id="error-message"></div>
    </div>

    <div class="main-content">
        <div id="graph"></div>
        <div id="stats"></div>
    </div>

    <script>
        let data = [];
        let errorMessage = document.getElementById('error-message');

        // Initialize Flatpickr for time range
        flatpickr("#time-range", {
            mode: "range",
            dateFormat: "Y-m-d",
            defaultDate: ["2014-01-01", "2014-12-31"],
            enableTime: false,
            onChange: updateGraph
        });

        // Load CSV data
        fetch('spruce_data.csv')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load CSV - please upload spruce_data.csv to the repository');
                }
                return response.text();
            })
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            errorMessage.textContent = 'CSV Parse Error: ' + results.errors[0].message;
                            return;
                        }
                        data = results.data;
                        console.log('Loaded data:', data.slice(0, 5));
                        populateDropdowns();
                        updateGraph();
                    }
                });
            })
            .catch(error => {
                errorMessage.textContent = error.message;
            });

        // Populate dropdowns with unique values from the data
        function populateDropdowns() {
            const plotSelect = document.getElementById('plot-select');
            const co2Select = document.getElementById('co2-select');
            const tempSelect = document.getElementById('temp-select');

            const plots = [...new Set(data.map(row => row.Plot))].filter(p => p).sort();
            const co2s = [...new Set(data.map(row => row.CO2_trmt))].filter(c => c).sort();
            const temps = [...new Set(data.map(row => row.Temp_target))].filter(t => t).sort();

            plots.forEach(plot => {
                const option = document.createElement('option');
                option.value = plot;
                option.textContent = `Plot ${plot}`;
                plotSelect.appendChild(option);
            });

            co2s.forEach(co2 => {
                const option = document.createElement('option');
                option.value = co2;
                option.textContent = co2 === 'Ambient' ? 'Ambient' : `${co2} ppm`;
                co2Select.appendChild(option);
            });

            temps.forEach(temp => {
                const option = document.createElement('option');
                option.value = temp;
                option.textContent = `${temp}°C`;
                tempSelect.appendChild(option);
            });

            plotSelect.addEventListener('change', updateGraph);
            co2Select.addEventListener('change', updateGraph);
            tempSelect.addEventListener('change', updateGraph);
            document.getElementById('depth-select').addEventListener('change', updateGraph);
            document.getElementById('view-select').addEventListener('change', updateGraph);
            document.getElementById('fit-select').addEventListener('change', updateGraph);
        }

        // Update the graph based on selections
        function updateGraph() {
            const plotSelect = document.getElementById('plot-select').value;
            const co2Select = document.getElementById('co2-select').value;
            const tempSelect = document.getElementById('temp-select').value;
            const depthSelect = document.getElementById('depth-select').value;
            const viewSelect = document.getElementById('view-select').value;
            const fitSelect = document.getElementById('fit-select').value;
            const timeRange = document.getElementById('time-range').value.split(' to ');

            const startDate = timeRange[0] ? new Date(timeRange[0]) : new Date('2014-01-01');
            const endDate = timeRange[1] ? new Date(timeRange[1]) : new Date('2014-12-31');

            // Filter data based on selections
            const filteredData = data.filter(row => {
                const rowDate = new Date(row.TIMESTAMP);
                return row.Plot === plotSelect &&
                       row.CO2_trmt === co2Select &&
                       row.Temp_target === tempSelect &&
                       rowDate >= startDate &&
                       rowDate <= endDate;
            });

            console.log('Selections:', { plotSelect, co2Select, tempSelect, depthSelect, timeRange });
            console.log('Filtered data (first 5):', filteredData.slice(0, 5));

            if (filteredData.length === 0) {
                Plotly.newPlot('graph', [], { title: 'No data to plot after filtering' });
                document.getElementById('stats').textContent = 'No data points available.';
                return;
            }

            // Prepare data for plotting
            const x = filteredData.map(row => {
                const val = parseFloat(row.Day_of_Year);
                console.log('Parsing Day_of_Year:', row.Day_of_Year, '->', val);
                return val;
            });
            const y = filteredData.map(row => {
                const val = parseFloat(row[depthSelect]);
                console.log('Parsing', depthSelect, ':', row[depthSelect], '->', val);
                return val;
            });
            const timestamps = filteredData.map(row => row.TIMESTAMP);

            // Remove rows where x or y is NaN
            const validData = x.map((val, i) => ({ x: val, y: y[i], timestamp: timestamps[i] }))
                              .filter(d => !isNaN(d.x) && !isNaN(d.y));

            const validX = validData.map(d => d.x);
            const validY = validData.map(d => d.y);
            const validTimestamps = validData.map(d => d.timestamp);

            console.log('All data for regression - X:', validX);
            console.log('Y:', validY);

            if (validX.length === 0) {
                Plotly.newPlot('graph', [], { title: 'No valid data points to plot (check for missing or invalid values)' });
                document.getElementById('stats').textContent = 'No valid data points available.';
                return;
            }

            // Create the main trace
            const trace = {
                x: validX,
                y: validY,
                mode: viewSelect === 'scatter' ? 'markers' : viewSelect === 'line' ? 'lines' : 'bars',
                type: viewSelect === 'bar' ? 'bar' : 'scatter',
                name: `${depthSelect} vs Day of Year`,
                text: validTimestamps,
                hovertemplate: `Day of Year: %{x}<br>${depthSelect}: %{y}°C<br>Timestamp: %{text}`
            };

            const traces = [trace];

            // Add regression fit if selected
            let statsText = '';
            if (fitSelect !== 'none' && validX.length >= 3) {
                let fit;
                if (fitSelect === 'linear') {
                    fit = linearRegression(validX, validY);
                    statsText = `Linear Fit: y = ${fit.slope.toFixed(2)}x + ${fit.intercept.toFixed(2)}`;
                    traces.push({
                        x: validX,
                        y: validX.map(x => fit.slope * x + fit.intercept),
                        mode: 'lines',
                        name: 'Linear Fit',
                        line: { color: 'red' }
                    });
                } else if (fitSelect === 'quadratic') {
                    fit = quadraticRegression(validX, validY);
                    statsText = `Quadratic Fit: y = ${fit.a.toFixed(2)}x² + ${fit.b.toFixed(2)}x + ${fit.c.toFixed(2)}`;
                    traces.push({
                        x: validX,
                        y: validX.map(x => fit.a * x * x + fit.b * x + fit.c),
                        mode: 'lines',
                        name: 'Quadratic Fit',
                        line: { color: 'red' }
                    });
                }
            } else if (fitSelect !== 'none') {
                statsText = 'Not enough data points for fit (need at least 3)';
            }

            console.log('Traces to plot:', traces);
            console.log('Stats text:', statsText);

            // Plot the graph
            const layout = {
                title: `Soil Temperature (${depthSelect}) vs Day of Year (Plot ${plotSelect}, CO2: ${co2Select}, Temp: ${tempSelect}°C)`,
                xaxis: { title: 'Day of Year' },
                yaxis: { title: 'Soil Temperature (°C)' },
                margin: { t: 50, b: 50, l: 50, r: 50 }
            };

            Plotly.newPlot('graph', traces, layout).catch(err => {
                console.error('Plotly rendering error:', err);
                document.getElementById('graph').innerHTML = 'Error rendering graph. Please check the console for details.';
            });
            document.getElementById('stats').textContent = statsText;
        }

        // Linear regression
        function linearRegression(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.map((xi, i) => xi * y[i]).reduce((a, b) => a + b, 0);
            const sumXX = x.map(xi => xi * xi).reduce((a, b) => a + b, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            return { slope, intercept };
        }

        // Quadratic regression
        function quadraticRegression(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumX2 = x.map(xi => xi * xi).reduce((a, b) => a + b, 0);
            const sumX3 = x.map(xi => xi ** 3).reduce((a, b) => a + b, 0);
            const sumX4 = x.map(xi => xi ** 4).reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.map((xi, i) => xi * y[i]).reduce((a, b) => a + b, 0);
            const sumX2Y = x.map((xi, i) => xi * xi * y[i]).reduce((a, b) => a + b, 0);

            const denom = n * sumX2 * sumX4 - sumX2 * sumX2 * sumX2 + 2 * sumX * sumX2 * sumX3 - n * sumX3 * sumX3 - sumX * sumX * sumX4;
            const a = (n * sumX2 * sumX2Y + sumX * sumX3 * sumY + sumX2 * sumX * sumXY - sumX2 * sumX2 * sumY - n * sumX3 * sumXY - sumX * sumX2Y * sumX2) / denom;
            const b = (n * sumX4 * sumXY + sumX2 * sumX2 * sumY + sumX * sumX2Y * sumX2 - sumX2 * sumX3 * sumY - n * sumX2 * sumX2Y - sumX * sumX4 * sumY) / denom;
            const c = (sumX2 * sumX4 * sumY + sumX3 * sumX2 * sumXY + sumX * sumX2Y * sumX3 - sumX2 * sumX2 * sumX2Y - sumX * sumX4 * sumXY - sumX3 * sumX3 * sumY) / denom;

            return { a, b, c };
        }
    </script>
</body>
</html>
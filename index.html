<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Biospheromics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Exo+2:wght@700&family=VT323&family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw; 
            background-color: #000000; 
            font-family: 'Lato', sans-serif; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        h1 { 
            color: #00FFFF; 
            text-align: center; 
            padding: 2vh; 
            font-family: 'Comfortaa', 'Orbitron', 'Exo 2', sans-serif; 
            font-size: calc(16px + 1.5vw); 
            margin: 0; 
            text-shadow: 2px 2px 4px #00CC66, -2px -2px 4px #00CC66, 0 0 10px #00FFFF; 
            animation: glowBreathe 8s cubic-bezier(0.45, 0, 0.55, 1) infinite; 
            flex-shrink: 0; 
            z-index: 11; 
            line-height: 1.2; /* Reduced for tighter title */
        }
        @keyframes glowBreathe {
            0% { text-shadow: 2px 2px 4px #00CC66, -2px -2px 4px #00CC66, 0 0 10px #00FFFF; }
            25% { text-shadow: 2px 2px 5px #00CC66, -2px -2px 5px #00CC66, 0 0 12px #00FFFF; }
            50% { text-shadow: 2px 2px 4.5px #00CC66, -2px -2px 4.5px #00CC66, 0 0 11px #00FFFF; }
            75% { text-shadow: 2px 2px 5px #00CC66, -2px -2px 5px #00CC66, 0 0 12px #00FFFF; }
            100% { text-shadow: 2px 2px 4px #00CC66, -2px -2px 4px #00CC66, 0 0 10px #00FFFF; }
        }
        .container { 
            display: flex; 
            flex-grow: 1; 
            overflow: hidden; 
            height: calc(100vh - 4vh); 
            position: relative;
        }
        .sidebar { 
            width: 250px; 
            background: rgba(26, 26, 26, 0.8); 
            border-right: 2px solid #00FFFF; 
            padding: 10px; /* Reduced from 15px */
            display: flex; 
            flex-direction: column; 
            gap: 8px; /* Tighter spacing */
            position: absolute; 
            top: 0; 
            left: 0;
            height: 100%; 
            transition: transform 0.3s ease; 
            z-index: 10; 
        }
        .sidebar.collapsed { transform: translateX(-250px); }
        .sidebar-tab { 
            position: absolute; 
            top: 0; 
            right: -40px; 
            width: 40px; 
            height: 40px; 
            background: rgba(26, 26, 26, 0.8); 
            border: 2px solid #00FFFF; 
            border-left: none; 
            border-radius: 0 10px 10px 0; 
            color: #00FFFF; 
            font-size: 19px; 
            line-height: 36px; 
            text-align: center; 
            cursor: pointer; 
            box-shadow: 0 0 8px #00FFFF; 
        }
        .sidebar-title { 
            font-family: 'Exo 2', sans-serif; 
            font-size: 28px; 
            color: #DAA520; 
            text-align: center; 
            text-shadow: 0 0 10px #DAA520; 
            line-height: 1.1; 
            margin: 0 0 8px; /* Tighter spacing */
        }
        .sidebar-title span { 
            display: block; 
            font-size: 20px; 
        }
        .button-container { 
            display: flex; 
            align-items: center; 
            width: 100%; 
            position: relative; 
            margin: 0; /* No extra margin */
        }
        .button-label { 
            color: #FFFF00; 
            font-size: 15px; 
            margin-right: 8px; /* Reduced from 10px */
            width: 100px; 
            text-align: right; 
            padding-left: 10px; 
        }
        .dropdown-toggle, #control-panel-button { 
            background: rgba(26, 26, 26, 0.8); 
            border: 2px solid #00FFFF; 
            border-radius: 10px; 
            color: #00FFFF; 
            font-size: 13px; 
            padding: 4px 6px; /* Reduced from 6px 8px */
            width: calc(100% - 118px); /* Adjusted for tighter fit */
            text-align: center; 
            cursor: pointer; 
            box-shadow: 0 0 8px #00FFFF; 
            line-height: 1.2; /* Minimized height */
            white-space: nowrap; /* Prevent wrapping unless necessary */
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        #time-range-toggle { 
            white-space: pre-wrap; /* Allow line break for dates */
            line-height: 1.2; 
        }
        .dropdown-menu { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 100%; 
            background: rgba(26, 26, 26, 0.9); 
            border: 2px solid #00FFFF; 
            border-radius: 10px; 
            color: #00FFFF; 
            font-size: 13px; 
            padding: 8px; 
            transition: max-height 0.5s ease; 
            visibility: hidden; 
            z-index: 10; 
        }
        #stats-menu { 
            top: auto; 
            bottom: 100%; 
            max-height: 400px; 
            color: #00FF00; 
            font-family: 'VT323', monospace; 
            font-size: 17px; 
        }
        .dropdown-menu.open { visibility: visible; }
        .dropdown-item { display: flex; align-items: center; margin-bottom: 5px; }
        #dependent-menu .dropdown-item label, #independent-menu .dropdown-item label { margin-left: 5px; }
        #time-range-menu { padding: 10px; }
        #time-range-menu .dropdown-item { flex-direction: column; align-items: flex-start; margin-bottom: 10px; }
        #time-range-menu input[type="text"] { 
            width: 100%; 
            background: rgba(26, 26, 26, 0.8); 
            border: 1px solid #00FFFF; 
            color: #00FFFF; 
            padding: 4px; 
            margin-top: 5px; 
            font-size: 13px; 
        }
        .graph-container { 
            position: absolute; 
            right: 0; 
            width: calc(100vw - 250px); 
            background-color: #1A1A1A; 
            height: calc(100vh - 4vh); 
            transition: width 0.3s ease, left 0.3s ease; 
            z-index: 1; 
            overflow: hidden; 
        }
        .graph-container.full-width { 
            width: 100vw; 
            left: 0; 
        }
        #graph { 
            width: 100%; 
            height: 100%; 
            min-width: 320px; 
            min-height: 240px; 
        }
        .welcome-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00FF00;
            font-family: 'VT323', monospace;
            font-size: 20px;
            text-align: center;
            text-shadow: 0 0 10px #00FF00;
        }
        .welcome-message img {
            display: block;
            margin: 0 auto;
            max-width: 300px;
            height: auto;
        }
        .welcome-message hr {
            border: 1px solid #00FFFF;
            width: 80%;
            margin: 10px auto;
        }
        .legend-tab { 
            position: absolute; 
            top: 50px; /* Below sidebar-tab */
            right: -40px; 
            width: 40px; 
            height: 40px; 
            background: rgba(26, 26, 26, 0.8); 
            border: 2px solid #00FFFF; 
            border-left: none; 
            border-radius: 0 10px 10px 0; 
            color: #00FFFF; 
            font-size: 19px; 
            line-height: 36px; 
            text-align: center; 
            cursor: pointer; 
            box-shadow: 0 0 8px #00FFFF; 
            z-index: 5; 
        }
        .controls-popup, .stats-popup, .warning-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            padding: 15px;
            color: #00FFFF;
            font-size: 13px;
            z-index: 20;
            display: none;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
        }
        .warning-popup {
            color: #FF4500;
            font-family: 'VT323', monospace;
            font-size: 17px;
            width: 250px;
        }
        .controls-popup h3, .stats-popup h3, .warning-popup h3 {
            margin: 0 0 10px;
            color: #DAA520;
            text-align: center;
            font-family: 'Exo 2', sans-serif;
            font-size: 18px;
        }
        .slider-container {
            margin: 10px 0;
            position: relative;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            color: #00FFFF;
        }
        .range-slider {
            position: relative;
            width: 100%;
            height: 5px;
            background: #444;
            border-radius: 5px;
        }
        .range-slider input[type="range"] {
            position: absolute;
            width: 100%;
            height: 5px;
            top: -5px;
            background: none;
            -webkit-appearance: none;
            pointer-events: none;
        }
        .range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: #00FFFF;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 5px #00FFFF;
        }
        .range-slider input[type="range"]::-webkit-slider-runnable-track {
            background: transparent;
        }
        .slider-values {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #00FF00;
            margin-top: 5px;
        }
        .warning-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FF4500;
            font-family: 'VT323', monospace;
            font-size: 17px;
            text-align: center;
            text-shadow: 0 0 5px #FF4500;
            z-index: 5;
        }
        @media (max-width: 768px) {
            .sidebar { width: 200px; }
            .graph-container { width: calc(100vw - 200px); }
            .graph-container.full-width { width: 100vw; }
            .legend-tab { top: 50px; right: -40px; }
        }
        @media (max-width: 480px) {
            .sidebar { width: 150px; }
            .graph-container { width: calc(100vw - 150px); }
            .graph-container.full-width { width: 100vw; }
            .legend-tab { top: 50px; right: -40px; }
            .button-label { font-size: 13px; width: 80px; }
            .dropdown-toggle, #control-panel-button { width: calc(100% - 88px); }
            .dropdown-menu { width: calc(100% - 10px); left: 0; }
            .controls-popup, .stats-popup, .warning-popup { width: 90%; }
        }
    </style>
</head>
<body>
    <h1>Comparative Biospheromics Dashboard</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-tab" id="sidebar-tab"><</div>
            <div class="sidebar-title">SPRUCE<br><span>Data Explorer</span></div>
            <div class="button-container">
                <span class="button-label">Control Panel:</span>
                <div id="control-panel-button">Show Control Panel</div>
            </div>
            <div class="button-container">
                <span class="button-label">X-Axis:</span>
                <div class="dropdown-toggle" id="independent-toggle">Select Independent</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="Temp_target" value="Temp_target" checked><label for="Temp_target">Target Temperature (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_trmt" value="CO2_trmt"><label for="CO2_trmt">CO₂ Treatment (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TIMESTAMP" value="TIMESTAMP"><label for="TIMESTAMP">Time</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TA_2_0" value="TA_2_0"><label for="TA_2_0">Ambient Temp 2m (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="RH_2_0" value="RH_2_0"><label for="RH_2_0">Relative Humidity 2m (%)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction 10m (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2" value="PAR_2"><label for="PAR_2">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6" value="PRE_6"><label for="PREC_6">Precipitation (mm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_measured" value="CO2_measured"><label for="CO2_measured">Measured CO₂ (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="H2O_measured" value="H2O_measured"><label for="H2O_measured">Measured H₂O (mmol/mol)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Y-Axis:</span>
                <div class="dropdown-toggle" id="dependent-toggle">Select Dependent</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="TS_0" value="TS_0"><label for="TS_0" style="color: #00FFFF;">Soil Temp 0 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_5" value="TS_5"><label for="TS_5" style="color: #FFFF00;">Soil Temp 5 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_10" value="TS_10"><label for="TS_10" style="color: #FF00FF;">Soil Temp 10 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_20" value="TS_20"><label for="TS_20" style="color: #00FF00;">Soil Temp 20 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_30" value="TS_30"><label for="TS_30" style="color: #FF0000;">Soil Temp 30 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_40" value="TS_40"><label for="TS_40" style="color: #0000FF;">Soil Temp 40 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_50" value="TS_50"><label for="TS_50" style="color: #FFA500;">Soil Temp 50 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_100" value="TS_100"><label for="TS_100" style="color: #800080;">Soil Temp 100 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_200" value="TS_200"><label for="TS_200" style="color: #008080;">Soil Temp 200 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TA_2_0_dep" value="TA_2_0"><label for="TA_2_0_dep" style="color: #FF6347;">Ambient Temp 2m (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="RH_2_0_dep" value="RH_2_0"><label for="RH_2_0_dep" style="color: #4682B4;">Relative Humidity 2m (%)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10_dep" value="WD_10"><label for="WD_10_dep" style="color: #6A5ACD;">Wind Direction 10m (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2_dep" value="PAR_2"><label for="PAR_2_dep" style="color: #20B2AA;">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6_dep" value="PREC_6"><label for="PREC_6_dep" style="color: #DAA520;">Precipitation (mm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_measured_dep" value="CO2_measured"><label for="CO2_measured_dep" style="color: #FF69B4;">Measured CO₂ (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="H2O_measured_dep" value="H2O_measured"><label for="H2O_measured_dep" style="color: #7FFF00;">Measured H₂O (mmol/mol)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Time Range:</span>
                <div class="dropdown-toggle" id="time-range-toggle">2015-08-01<br>2025-04-05</div>
                <div class="dropdown-menu" id="time-range-menu">
                    <div class="dropdown-item"><label for="start-date">Start Date:</label><input type="text" id="start-date" value="2015-08-01"></div>
                    <div class="dropdown-item"><label for="end-date">End Date:</label><input type="text" id="end-date" value="2025-04-05"></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Analysis Type:</span>
                <div class="dropdown-toggle" id="chart-type-toggle">Scatter</div>
                <div class="dropdown-menu" id="chart-type-menu">
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="scatter" value="scatter" checked><label for="scatter">Scatter</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="line" value="line"><label for="line">Line</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="bar" value="bar"><label for="bar">Bar</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="area" value="area"><label for="area">Area</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="box" value="box"><label for="box">Box</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="anova" value="anova"><label for="anova">ANOVA</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Stats:</span>
                <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                <div class="dropdown-menu" id="stats-menu">
                    <div id="stats-content"></div>
                    <div class="dropdown-item"><input type="checkbox" id="show-best-fit" checked><label for="show-best-fit">Show Best Fit</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="show-stats" checked><label for="show-stats">Show Stats on Chart</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="show-stats-popup"><label for="show-stats-popup">Show Stats Popup</label></div>
                </div>
            </div>
        </div>
        <div class="graph-container" id="graph-container">
            <div id="graph">
                <div class="welcome-message">
                    <a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a>
                    <hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015
                </div>
            </div>
            <div class="legend-tab" id="legend-tab">L</div>
        </div>
    </div>
    <div class="controls-popup" id="controls-popup">
        <h3 id="controls-title">Controls</h3>
        <div id="controls-content"></div>
    </div>
    <div class="controls-popup" id="control-panel-popup">
        <h3>Control Panel</h3>
        <div id="control-panel-content"></div>
    </div>
    <div class="stats-popup" id="stats-popup">
        <h3>Statistics</h3>
        <div id="stats-popup-content"></div>
    </div>
    <div class="warning-popup" id="warning-popup">
        <h3>Warning</h3>
        <div id="warning-content"></div>
    </div>

    <script>
        let allData = [];
        const dataUrl = 'https://raw.githubusercontent.com/aime2solve/SPRUCE/main/spruce_daily_with_co2_h2o.json';
        let startDate = new Date('2015-08-01');
        let endDate = new Date('2025-04-05');
        let dataLoaded = false;
        let legendVisible = true;

        const dependentColors = {
            'TS_0': '#00FFFF', 'TS_5': '#FFFF00', 'TS_10': '#FF00FF', 'TS_20': '#00FF00', 'TS_30': '#FF0000',
            'TS_40': '#0000FF', 'TS_50': '#FFA500', 'TS_100': '#800080', 'TS_200': '#008080',
            'TA_2_0': '#FF6347', 'RH_2_0': '#4682B4', 'WD_10': '#6A5ACD', 'PAR_2': '#20B2AA',
            'PREC_6': '#DAA520', 'CO2_measured': '#FF69B4', 'H2O_measured': '#7FFF00'
        };

        const controlRanges = {
            'TS_200': { min: -10, max: 30, defaultMin: -10, defaultMax: 30, label: 'Soil Temp (°C)' },
            'Soil_Depth': { min: 0, max: 200, defaultMin: 0, defaultMax: 200, label: 'Soil Depth (cm)' },
            'TA_2_0': { min: -20, max: 40, defaultMin: -20, defaultMax: 40, label: 'Ambient Temp 2m (°C)' },
            'CO2_measured': { min: 300, max: 1000, defaultMin: 300, defaultMax: 1000, label: 'Measured CO₂ (ppm)' },
            'H2O_measured': { min: 0, max: 30, defaultMin: 0, defaultMax: 30, label: 'Measured H₂O (mmol/mol)' },
            'RH_2_0': { min: 0, max: 100, defaultMin: 0, defaultMax: 100, label: 'Relative Humidity 2m (%)' },
            'WD_10': { min: 0, max: 360, defaultMin: 0, defaultMax: 360, label: 'Wind Direction 10m (°)' },
            'PAR_2': { min: 0, max: 2000, defaultMin: 0, defaultMax: 2000, label: 'PAR (µmol/m²s)' },
            'PREC_6': { min: 0, max: 100, defaultMin: 0, defaultMax: 100, label: 'Precipitation (mm)' }
        };
        let currentRanges = { ...controlRanges };
        let tempRange = [0, 9];
        let depthRange = [0, 200];

        const unitMap = {
            'TS_0': '°C', 'TS_5': '°C', 'TS_10': '°C', 'TS_20': '°C', 'TS_30': '°C', 
            'TS_40': '°C', 'TS_50': '°C', 'TS_100': '°C', 'TS_200': '°C', 'TA_2_0': '°C',
            'RH_2_0': '%', 'WD_10': '°', 'PAR_2': 'µmol/m²s', 'PREC_6': 'mm',
            'CO2_measured': 'ppm', 'H2O_measured': 'mmol/mol'
        };

        const multiVarAnalysisTypes = ['anova'];

        async function loadData() {
            try {
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                allData = await response.json();
                allData = allData.filter(row => {
                    row.TIMESTAMP = new Date(row.TIMESTAMP);
                    return !isNaN(row.TIMESTAMP) && row.TIMESTAMP instanceof Date;
                });
                console.log('Loaded data sample:', allData.slice(0, 5));
                dataLoaded = true;
                updateGraph();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('graph').innerHTML = '<div class="welcome-message"><a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a><hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015</div>';
            }
        }

        function toggleDropdown(id) {
            const menus = document.querySelectorAll('.dropdown-menu');
            menus.forEach(menu => {
                if (menu.id !== id && menu.classList.contains('open')) {
                    menu.classList.remove('open');
                }
            });
            const menu = document.getElementById(id);
            if (menu) menu.classList.toggle('open');
        }

        function showWarningPopup(message) {
            const popup = document.getElementById('warning-popup');
            document.getElementById('warning-content').textContent = message;
            popup.style.display = 'block';
            setTimeout(() => popup.style.display = 'none', 2000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const graphContainer = document.getElementById('graph-container');
            const tab = document.getElementById('sidebar-tab');
            sidebar.classList.toggle('collapsed');
            graphContainer.classList.toggle('full-width');
            tab.textContent = sidebar.classList.contains('collapsed') ? '>' : '<';
            if (dataLoaded && typeof Plotly !== 'undefined') {
                Plotly.relayout('graph', { width: calculateGraphWidth(), height: calculateGraphHeight() });
            }
        }

        function filterByRanges(data) {
            return data.filter(row => {
                return Object.keys(currentRanges).every(key => {
                    if (key === 'Soil_Depth') return true;
                    const value = parseFloat(row[key]);
                    const range = currentRanges[key];
                    return isNaN(value) || (value >= range.defaultMin && value <= range.defaultMax);
                });
            });
        }

        function filterByTempRange(data) {
            return data.filter(row => {
                const tempValue = parseFloat(row.Temp_target);
                return tempValue >= tempRange[0] && tempValue <= tempRange[1];
            });
        }

        function filterByDepthRange(data) {
            const depths = [0, 5, 10, 20, 30, 40, 50, 100, 200];
            return data.map(row => {
                const newRow = { ...row };
                depths.forEach(depth => {
                    if (depth < depthRange[0] || depth > depthRange[1]) {
                        newRow[`TS_${depth}`] = null;
                    }
                });
                return newRow;
            });
        }

        function showControlsPopup(independent) {
            const popup = document.getElementById('controls-popup');
            if (independent.length > 1 || (independent[0] !== 'CO2_trmt' && independent[0] !== 'Temp_target')) {
                popup.style.display = 'none'; // Placeholder
            } else {
                popup.style.display = 'none';
            }
        }

        function toggleControlPanel() {
            const popup = document.getElementById('control-panel-popup');
            const content = document.getElementById('control-panel-content');
            const button = document.getElementById('control-panel-button');
            const isVisible = popup.style.display === 'block';
            popup.style.display = isVisible ? 'none' : 'block';
            button.textContent = isVisible ? 'Show Control Panel' : 'Hide Control Panel';

            if (!isVisible) {
                content.innerHTML = Object.keys(controlRanges).map(key => `
                    <div class="slider-container">
                        <label>${controlRanges[key].label}</label>
                        <div class="range-slider">
                            <input type="range" id="${key}-min" min="${controlRanges[key].min}" max="${controlRanges[key].max}" value="${currentRanges[key].defaultMin}" step="${key === 'Soil_Depth' ? 5 : 0.1}">
                            <input type="range" id="${key}-max" min="${controlRanges[key].min}" max="${controlRanges[key].max}" value="${currentRanges[key].defaultMax}" step="${key === 'Soil_Depth' ? 5 : 0.1}">
                        </div>
                        <div class="slider-values">
                            <span id="${key}-min-value">${currentRanges[key].defaultMin}</span>
                            <span id="${key}-max-value">${currentRanges[key].defaultMax}</span>
                        </div>
                    </div>
                `).join('');

                Object.keys(controlRanges).forEach(key => {
                    const minSlider = document.getElementById(`${key}-min`);
                    const maxSlider = document.getElementById(`${key}-max`);
                    const minValue = document.getElementById(`${key}-min-value`);
                    const maxValue = document.getElementById(`${key}-max-value`);

                    minSlider.addEventListener('input', () => {
                        const value = parseFloat(minSlider.value);
                        minValue.textContent = value;
                        if (value > parseFloat(maxSlider.value)) maxSlider.value = value;
                        currentRanges[key].defaultMin = value;
                        if (key === 'Soil_Depth') depthRange[0] = value;
                        updateGraph();
                    });

                    maxSlider.addEventListener('input', () => {
                        const value = parseFloat(maxSlider.value);
                        maxValue.textContent = value;
                        if (value < parseFloat(minSlider.value)) minSlider.value = value;
                        currentRanges[key].defaultMax = value;
                        if (key === 'Soil_Depth') depthRange[1] = value;
                        updateGraph();
                    });
                });
            }
        }

        function calculateRegression(x, y) {
            const pairedData = x.map((xi, i) => ({ x: xi, y: y[i] })).filter(d => !isNaN(d.x) && !isNaN(d.y));
            if (pairedData.length < 2) return { slope: NaN, intercept: NaN, rSquared: NaN, pValue: NaN, tStat: NaN, fStat: NaN, seSlope: NaN, rse: NaN };

            const yValues = pairedData.map(d => d.y).sort((a, b) => a - b);
            const q1 = yValues[Math.floor(yValues.length * 0.25)];
            const q3 = yValues[Math.floor(yValues.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            const filteredData = pairedData.filter(d => d.y >= lowerBound && d.y <= upperBound);
            const filteredX = filteredData.map(d => d.x);
            const filteredY = filteredData.map(d => d.y);

            const n = filteredX.length;
            if (n < 2) return { slope: NaN, intercept: NaN, rSquared: NaN, pValue: NaN, tStat: NaN, fStat: NaN, seSlope: NaN, rse: NaN };

            const sumX = filteredX.reduce((a, b) => a + b, 0);
            const sumY = filteredY.reduce((a, b) => a + b, 0);
            const sumXY = filteredX.reduce((sum, xi, i) => sum + xi * filteredY[i], 0);
            const sumXX = filteredX.reduce((sum, xi) => sum + xi * xi, 0);
            const meanX = sumX / n;
            const meanY = sumY / n;
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            const yPred = filteredX.map(xi => slope * xi + intercept);
            const ssTot = filteredY.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0);
            const ssRes = filteredY.reduce((sum, yi, i) => sum + Math.pow(yi - yPred[i], 2), 0);
            const ssReg = ssTot - ssRes;
            const rSquared = ssTot === 0 ? NaN : 1 - (ssRes / ssTot);
            const adjustedRSquared = 1 - (1 - rSquared) * (n - 1) / (n - 2);
            const rse = Math.sqrt(ssRes / (n - 2));
            const seSlope = rse / Math.sqrt(filteredX.reduce((sum, xi) => sum + Math.pow(xi - meanX, 2), 0));
            const tStat = slope / seSlope;
            const fStat = (ssReg / 1) / (ssRes / (n - 2));

            const tDistPValue = (t) => {
                const df = n - 2;
                const tAbs = Math.abs(t);
                if (df > 100) return 2 * (1 - gaussianCDF(tAbs));
                return 2 * (1 - tDistCDF(tAbs, df));
            };
            const pValueSlope = tDistPValue(tStat);
            const pValueF = tDistPValue(Math.sqrt(fStat));

            return { slope, intercept, rSquared, adjustedRSquared, pValueSlope, tStat, fStat, pValueF, seSlope, rse };
        }

        function gaussianCDF(z) {
            return 0.5 * (1 + erf(z / Math.sqrt(2)));
        }

        function erf(x) {
            const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429;
            const p = 0.3275911;
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x);
            const t = 1 / (1 + p * x);
            return sign * (1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x));
        }

        function tDistCDF(t, df) {
            return gaussianCDF(t);
        }

        function calculateSpearman(x, y) {
            const pairedData = x.map((xi, i) => ({ x: xi, y: y[i] })).filter(d => !isNaN(d.x) && !isNaN(d.y));
            if (pairedData.length < 2) return { rho: NaN, pValue: NaN };
            const rankedX = pairedData.map(d => d.x).map((v, i, arr) => ({ v, i })).sort((a, b) => a.v - b.v).map((d, r) => ({ i: d.i, r: r + 1 }));
            const rankedY = pairedData.map(d => d.y).map((v, i, arr) => ({ v, i })).sort((a, b) => a.v - b.v).map((d, r) => ({ i: d.i, r: r + 1 }));
            const n = pairedData.length;
            const dSquared = rankedX.reduce((sum, rx, i) => sum + Math.pow(rx.r - rankedY[i].r, 2), 0);
            const rho = 1 - (6 * dSquared) / (n * (n * n - 1));
            const tStat = rho * Math.sqrt((n - 2) / (1 - rho * rho));
            const pValue = tDistPValue(tStat);
            return { rho, pValue };
        }

        function aggregateVariables(data) {
            const depths = [0, 5, 10, 20, 30, 40, 50, 100, 200];
            const zones = ['A', 'B', 'C'];
            return data.map(row => {
                const newRow = { ...row };
                depths.forEach(depth => {
                    const keys = zones.map(zone => `TS_${depth}_${zone}${depth === 0 ? 1 : depth === 5 ? 2 : depth === 10 ? 3 : depth === 20 ? 4 : depth === 30 ? 5 : depth === 40 ? 6 : depth === 50 ? 7 : depth === 100 ? 8 : 9}`);
                    const values = keys.map(k => parseFloat(row[k])).filter(v => !isNaN(v));
                    newRow[`TS_${depth}`] = values.length > 0 ? values.reduce((sum, v) => sum + v, 0) / values.length : null;
                });
                const taKeys = ['TA_2_0_1', 'TA_2_0_2'];
                const taValues = taKeys.map(k => parseFloat(row[k])).filter(v => !isNaN(v));
                newRow['TA_2_0'] = taValues.length > 0 ? taValues.reduce((sum, v) => sum + v, 0) / taValues.length : null;
                const rhKeys = ['RH_2_0_1', 'RH_2_0_2'];
                const rhValues = rhKeys.map(k => parseFloat(row[k])).filter(v => !isNaN(v));
                newRow['RH_2_0'] = rhValues.length > 0 ? rhValues.reduce((sum, v) => sum + v, 0) / rhValues.length : null;
                return newRow;
            });
        }

        function getWeeklyTimestamps(data, start, end) {
            const weeklyData = {};
            data.forEach(row => {
                const date = row.TIMESTAMP;
                if ((!start || date >= start) && (!end || date <= new Date(end.getTime() + 24 * 60 * 60 * 1000 - 1))) {
                    const weekStart = new Date(date);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    const key = weekStart.toISOString().split('T')[0];
                    if (!weeklyData[key]) weeklyData[key] = { TIMESTAMP: weekStart, values: {} };
                    Object.keys(row).forEach(k => {
                        if (k !== 'TIMESTAMP') {
                            weeklyData[key].values[k] = weeklyData[key].values[k] || [];
                            const value = parseFloat(row[k]);
                            if (!isNaN(value)) weeklyData[key].values[k].push(value);
                        }
                    });
                }
            });
            return Object.values(weeklyData).map(w => ({
                TIMESTAMP: w.TIMESTAMP,
                ...Object.keys(w.values).reduce((acc, k) => ({
                    ...acc,
                    [k]: w.values[k].length > 0 ? w.values[k].reduce((sum, v) => sum + v, 0) / w.values[k].length : null
                }), {})
            }));
        }

        function calculateGraphWidth() {
            return document.getElementById('graph-container').clientWidth;
        }

        function calculateGraphHeight() {
            return document.getElementById('graph-container').clientHeight;
        }

        function toggleLegend() {
            if (dataLoaded && typeof Plotly !== 'undefined') {
                legendVisible = !legendVisible;
                Plotly.relayout('graph', { showlegend: legendVisible });
                document.getElementById('legend-tab').textContent = legendVisible ? 'L' : 'L'; // Keep simple
            }
        }

        function filterOutliers(x, y) {
            const pairedData = x.map((xi, i) => ({ x: xi, y: y[i] })).filter(d => !isNaN(d.x) && !isNaN(d.y));
            if (pairedData.length < 2) return { x: x, y: y };
            const yValues = pairedData.map(d => d.y).sort((a, b) => a - b);
            const q1 = yValues[Math.floor(yValues.length * 0.25)];
            const q3 = yValues[Math.floor(yValues.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            const filtered = pairedData.filter(d => d.y >= lowerBound && d.y <= upperBound);
            return { x: filtered.map(d => d.x), y: filtered.map(d => d.y) };
        }

        function updateGraph() {
            const graphDiv = document.getElementById('graph');
            if (!dataLoaded || typeof Plotly === 'undefined') {
                graphDiv.innerHTML = '<div class="welcome-message"><a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a><hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015</div>';
                return;
            }

            const independents = Array.from(document.querySelectorAll('#independent-menu input:checked')).map(input => input.value);
            const allDependents = Array.from(document.querySelectorAll('#dependent-menu input:checked')).map(input => input.value);
            const chartType = document.querySelector('#chart-type-menu input:checked').value;
            const showBestFit = document.getElementById('show-best-fit').checked;
            const showStats = document.getElementById('show-stats').checked;
            const showStatsPopup = document.getElementById('show-stats-popup').checked;

            if (!allDependents.length || !independents.length) {
                graphDiv.innerHTML = '<div class="welcome-message"><a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a><hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015</div>';
                return;
            }

            let workingData = filterByRanges(allData);
            if (independents.includes('Temp_target')) workingData = filterByTempRange(workingData);
            workingData = filterByDepthRange(workingData);
            if (!workingData.length) {
                graphDiv.innerHTML = '<div class="welcome-message"><a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a><hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015</div>';
                return;
            }

            if (startDate || endDate) {
                workingData = workingData.filter(row => {
                    const rowDate = row.TIMESTAMP;
                    return (!startDate || rowDate >= startDate) && (!endDate || rowDate <= new Date(endDate.getTime() + 24 * 60 * 60 * 1000 - 1));
                });
            }

            workingData = aggregateVariables(workingData);
            if (independents.includes('TIMESTAMP')) {
                workingData = getWeeklyTimestamps(workingData, startDate, endDate);
            }

            const units = allDependents.map(dep => unitMap[dep]);
            const commonUnit = units[0];
            const dependents = allDependents.filter(dep => unitMap[dep] === commonUnit);
            if (!dependents.length) {
                graphDiv.innerHTML = '<div class="welcome-message"><a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a><hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015</div>';
                return;
            }

            const traces = [];
            const fitTraces = [];
            let invalidTraces = [];
            const statsData = [];

            if (chartType !== 'anova' || independents.length === 1) {
                const independent = independents[0];
                dependents.forEach(dep => {
                    let xValues = workingData.map(row => independent === 'TIMESTAMP' ? row.TIMESTAMP : parseFloat(row[independent])).filter(v => v !== null && !isNaN(v));
                    let yValues = workingData.map(row => parseFloat(row[dep])).filter(v => v !== null && !isNaN(v));

                    if (xValues.length === 0 || yValues.length === 0 || xValues.length !== yValues.length) {
                        console.log(`Invalid data for ${dep} vs ${independent}: xValues=${xValues.length}, yValues=${yValues.length}`);
                        invalidTraces.push(`${document.querySelector(`label[for="${dep}"], label[for="${dep}_dep"]`)?.textContent || dep} has no valid data`);
                        return;
                    }

                    const filtered = filterOutliers(xValues, yValues);
                    xValues = filtered.x;
                    yValues = filtered.y;

                    const color = dependentColors[dep] || '#FFFFFF';
                    const trace = {
                        x: xValues,
                        y: yValues,
                        mode: chartType === 'scatter' ? 'markers' : chartType === 'line' ? 'lines' : chartType === 'area' ? 'lines' : chartType === 'box' ? 'box' : 'bar',
                        type: chartType === 'scatter' ? 'scattergl' : chartType === 'area' ? 'scattergl' : chartType,
                        name: document.querySelector(`label[for="${dep}"], label[for="${dep}_dep"]`)?.textContent || dep,
                        marker: { color: color, size: 8 },
                        line: (chartType === 'line' || chartType === 'area') ? { color: color, width: 2 } : undefined,
                        fill: chartType === 'area' ? 'tozeroy' : undefined
                    };
                    traces.push(trace);

                    if (xValues.length > 1 && chartType !== 'box') {
                        const xNum = xValues.map(x => independent === 'TIMESTAMP' ? x.getTime() : x);
                        const reg = calculateRegression(xNum, yValues);
                        const spearman = calculateSpearman(xNum, yValues);
                        statsData.push({ dep, reg, spearman });

                        if (showBestFit && !isNaN(reg.slope) && !isNaN(reg.intercept)) {
                            const xFit = independent === 'TIMESTAMP' ? [new Date(Math.min(...xNum)), new Date(Math.max(...xNum))] : [Math.min(...xNum), Math.max(...xNum)];
                            const yFit = xFit.map(x => reg.slope * (independent === 'TIMESTAMP' ? x.getTime() : x) + reg.intercept);
                            fitTraces.push({
                                x: xFit,
                                y: yFit,
                                mode: 'lines',
                                type: 'scattergl',
                                name: `${document.querySelector(`label[for="${dep}"], label[for="${dep}_dep"]`)?.textContent || dep} (fit)`,
                                line: { color: color, width: 2, dash: 'dash' }
                            });
                        }
                    }
                });
            } else {
                graphDiv.innerHTML = '<div class="warning-message">ANOVA not fully implemented yet.</div>';
                return;
            }

            if (!traces.length) {
                graphDiv.innerHTML = `<div class="welcome-message"><a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a><hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015</div>
                              ${invalidTraces.length ? `<div class="warning-message">${invalidTraces.join('<br>')}</div>` : ''}`;
                return;
            }

            const statsText = statsData.map(({ dep, reg, spearman }) => {
                const label = document.querySelector(`label[for="${dep}"], label[for="${dep}_dep"]`)?.textContent || dep;
                return `${label}:\n` +
                       `  Slope: ${reg.slope.toFixed(4)}, SE: ${reg.seSlope.toFixed(4)}, t: ${reg.tStat.toFixed(4)}, p: ${reg.pValueSlope.toFixed(4)}\n` +
                       `  R²: ${reg.rSquared.toFixed(4)}, Adj R²: ${reg.adjustedRSquared.toFixed(4)}, F: ${reg.fStat.toFixed(4)}, p: ${reg.pValueF.toFixed(4)}\n` +
                       `  RSE: ${reg.rse.toFixed(4)}\n` +
                       `  Spearman ρ: ${spearman.rho.toFixed(4)}, p: ${spearman.pValue.toFixed(4)}`;
            }).join('\n\n');
            document.getElementById('stats-content').innerHTML = statsText.replace(/\n/g, '<br>');

            const popup = document.getElementById('stats-popup');
            popup.style.display = showStatsPopup ? 'block' : 'none';
            document.getElementById('stats-popup-content').innerHTML = statsText.replace(/\n/g, '<br>');

            const independent = independents[0];
            const xAxisTitle = independent === 'CO2_trmt' ? 'CO₂ Treatment (ppm)' : 
                               independent === 'TIMESTAMP' ? 'Time' : 
                               independent === 'Temp_target' ? 'Target Temperature (°C)' :
                               independent === 'CO2_measured' ? 'Measured CO₂ (ppm)' :
                               independent === 'H2O_measured' ? 'Measured H₂O (mmol/mol)' :
                               document.querySelector(`label[for="${independent}"]`)?.textContent || 'X-Axis';
            const isAllSoilTemp = dependents.every(dep => dep.startsWith('TS_'));
            const yAxisTitle = dependents.length === 1 ? 
                               document.querySelector(`label[for="${dependents[0]}"], label[for="${dependents[0]}_dep"]`)?.textContent :
                               isAllSoilTemp ? 'Soil Temp (°C)' : `${dependents.map(dep => document.querySelector(`label[for="${dep}"], label[for="${dep}_dep"]`)?.textContent.split(' ')[0]).join(', ')} (${commonUnit})`;

            const annotations = showStats ? [{
                x: 0.02,
                y: 0.98,
                xref: 'paper',
                yref: 'paper',
                text: statsData.map(({ dep, reg }) => {
                    const label = document.querySelector(`label[for="${dep}"], label[for="${dep}_dep"]`)?.textContent || dep;
                    return `${label}: Slope: ${reg.slope.toFixed(4)}, R²: ${reg.rSquared.toFixed(4)}`;
                }).join('<br>'),
                showarrow: false,
                font: { color: '#00FF00', family: 'Lato', size: 14 },
                bgcolor: 'rgba(26, 26, 26, 0.7)',
                bordercolor: '#00FFFF',
                borderwidth: 1,
                borderpad: 6,
                opacity: 0.9,
                align: 'left'
            }] : [];

            const layout = {
                width: calculateGraphWidth(),
                height: calculateGraphHeight(),
                plot_bgcolor: '#1A1A1A',
                paper_bgcolor: '#1A1A1A',
                font: { color: '#FFFFFF', size: 12 },
                title: {
                    text: `${yAxisTitle} vs. ${xAxisTitle}`,
                    font: { size: 16 },
                    x: 0.5,
                    xanchor: 'center',
                    y: 0.95,
                    yanchor: 'top'
                },
                xaxis: {
                    title: { text: xAxisTitle, font: { size: 14 } },
                    gridcolor: '#444',
                    zerolinecolor: '#444',
                    type: independent === 'TIMESTAMP' ? 'date' : 'linear',
                    automargin: true,
                    tickfont: { size: 12 },
                    autorange: independent === 'TIMESTAMP' ? true : undefined,
                    tickmode: independent === 'TIMESTAMP' ? 'auto' : undefined,
                    nticks: independent === 'TIMESTAMP' ? 5 : undefined
                },
                yaxis: {
                    title: { text: yAxisTitle, font: { size: 14 } },
                    gridcolor: '#444',
                    zerolinecolor: '#444',
                    automargin: true
                },
                margin: { t: 80, b: 120, l: 100, r: 40 },
                showlegend: legendVisible,
                legend: { 
                    x: 1, y: 1, xanchor: 'right', yanchor: 'top', 
                    bgcolor: 'rgba(26, 26, 26, 0.7)', bordercolor: 'transparent', 
                    borderwidth: 0, font: { color: '#FFFFFF', size: 12 }, 
                    traceorder: 'normal', orientation: 'v', cornerRadius: 10, 
                    shadow: '0 0 8px #00FFFF'
                },
                annotations: annotations,
                hovermode: 'closest'
            };

            console.log('Traces:', traces);
            console.log('Fit Traces:', fitTraces);

            // Ensure clean slate
            Plotly.purge('graph');
            Plotly.newPlot('graph', showBestFit ? traces.concat(fitTraces) : traces, layout, { responsive: true })
                .then(() => console.log('Plot successful'))
                .catch(err => {
                    console.error('Plotly error:', err);
                    graphDiv.innerHTML = `<div class="welcome-message"><a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a><hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO2 concentrations.<hr>Beginning August 2015</div>
                                          ${invalidTraces.length ? `<div class="warning-message">${invalidTraces.join('<br>')}</div>` : ''}`;
                });

            const dependentToggle = document.getElementById('dependent-toggle');
            const selectedLabels = Array.from(document.querySelectorAll('#dependent-menu input:checked'))
                .map(input => {
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    return `<span style="color: ${label.style.color}">${label.textContent}</span>`;
                }).join(', ');
            dependentToggle.innerHTML = selectedLabels || 'Select Dependent';
        }

        document.getElementById('sidebar-tab').addEventListener('click', toggleSidebar);
        document.getElementById('independent-toggle').addEventListener('click', () => toggleDropdown('independent-menu'));
        document.getElementById('dependent-toggle').addEventListener('click', () => toggleDropdown('dependent-menu'));
        document.getElementById('time-range-toggle').addEventListener('click', () => toggleDropdown('time-range-menu'));
        document.getElementById('stats-toggle').addEventListener('click', () => toggleDropdown('stats-menu'));
        document.getElementById('chart-type-toggle').addEventListener('click', () => toggleDropdown('chart-type-menu'));
        document.getElementById('legend-tab').addEventListener('click', toggleLegend);
        document.getElementById('control-panel-button').addEventListener('click', toggleControlPanel);
        document.getElementById('show-best-fit').addEventListener('change', updateGraph);
        document.getElementById('show-stats').addEventListener('change', updateGraph);
        document.getElementById('show-stats-popup').addEventListener('change', updateGraph);

        document.querySelectorAll('#independent-menu input').forEach(input => {
            input.addEventListener('change', () => {
                const chartType = document.querySelector('#chart-type-menu input:checked').value;
                const checkedInputs = Array.from(document.querySelectorAll('#independent-menu input:checked'));
                if (checkedInputs.length > 1 && !multiVarAnalysisTypes.includes(chartType)) {
                    input.checked = false;
                    showWarningPopup('Must choose ANOVA for multiple X-axis variables');
                    return;
                }
                document.getElementById('independent-toggle').textContent = 
                    checkedInputs.map(input => document.querySelector(`label[for="${input.id}"]`).textContent).join(', ') || 'Select Independent';
                showControlsPopup(checkedInputs.map(input => input.value));
                updateGraph();
            });
        });

        document.querySelectorAll('#dependent-menu input').forEach(input => {
            input.addEventListener('change', updateGraph);
        });

        document.querySelectorAll('#chart-type-menu input').forEach(input => {
            input.addEventListener('change', () => {
                document.getElementById('chart-type-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
                const checkedIndependents = Array.from(document.querySelectorAll('#independent-menu input:checked'));
                if (checkedIndependents.length > 1 && !multiVarAnalysisTypes.includes(input.value)) {
                    checkedIndependents.slice(1).forEach(extraInput => extraInput.checked = false);
                    document.getElementById('independent-toggle').textContent = 
                        document.querySelector(`label[for="${checkedIndependents[0].id}"]`).textContent || 'Select Independent';
                    showWarningPopup('Switched to single X-axis mode');
                }
                updateGraph();
            });
        });

        flatpickr('#start-date', {
            dateFormat: 'Y-m-d',
            defaultDate: '2015-08-01',
            onChange: (selectedDates) => {
                startDate = selectedDates[0];
                document.getElementById('time-range-toggle').innerHTML = 
                    `${startDate.toISOString().split('T')[0]}\n${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
                updateGraph();
            }
        });

        flatpickr('#end-date', {
            dateFormat: 'Y-m-d',
            defaultDate: '2025-04-05',
            onChange: (selectedDates) => {
                endDate = selectedDates[0];
                document.getElementById('time-range-toggle').innerHTML = 
                    `${startDate ? startDate.toISOString().split('T')[0] : 'Start'}\n${endDate.toISOString().split('T')[0]}`;
                updateGraph();
            }
        });

        window.addEventListener('resize', () => {
            if (dataLoaded && typeof Plotly !== 'undefined') {
                Plotly.relayout('graph', { width: calculateGraphWidth(), height: calculateGraphHeight() });
            }
        });

        loadData();
    </script>
</body>
</html>
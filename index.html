<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRUCE Soil Temperature Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Lato:wght@400;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000000;
            font-family: 'Lato', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #00FFFF;
            text-align: center;
            text-shadow: 0 0 10px #00CC66;
            padding: 3vh;
            font-family: 'Orbitron', sans-serif;
            font-size: calc(18px + 2vw);
            margin: 0;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: rgba(26, 26, 26, 0.8);
            border-right: 2px solid #00FFFF;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: fixed;
            top: 15vh;
            height: 85%;
        }
        .sidebar-title {
            font-family: 'Merriweather', serif;
            font-size: 24px;
            color: #DAA520;
            text-align: center;
            text-shadow: 0 0 10px #DAA520;
        }
        .button-container {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .button-label {
            color: #FFFF00;
            font-size: 12px;
            margin-right: 10px;
            width: 100px;
            text-align: right;
        }
        .dropdown-toggle {
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            color: #00FFFF;
            font-size: 10px;
            padding: 4px 8px;
            width: calc(100% - 120px);
            text-align: left;
            cursor: pointer;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 110px;
            width: calc(100% - 120px);
            max-height: 400px;
            overflow-y: auto;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #00FFFF;
            color: #00FFFF;
            font-size: 10px;
            padding: 8px;
        }
        .dropdown-menu.open {
            display: block;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        .dropdown-item input[type="radio"],
        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            accent-color: #00FFFF;
        }
        .stats-panel {
            display: none;
            width: calc(100% - 120px);
            max-height: 200px;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #00FFFF;
            color: #00FF00;
            font-size: 10px;
            padding: 8px;
            margin-left: auto;
            margin-top: 5px;
        }
        .stats-panel.open {
            display: block;
        }
        .graph-container {
            flex-grow: 1;
            margin-left: 300px;
            background-color: #1A1A1A;
            height: 98%;
        }
        #graph {
            width: 90%;
            height: 99%;
            margin: 0.5% auto;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
    <h1>SPRUCE Soil Temperature Dashboard</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-title">SPRUCE Data Explorer</div>
            <div class="button-container">
                <span class="button-label">Plot:</span>
                <div class="dropdown-toggle" id="plot-toggle">Select Plots</div>
                <div class="dropdown-menu" id="plot-menu"></div>
            </div>
            <div class="button-container">
                <span class="button-label">Independent:</span>
                <div class="dropdown-toggle" id="independent-toggle">Temp_target</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="radio" name="independent" id="Temp_target" value="Temp_target" checked><label for="Temp_target">Target Temperature (°C)</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="CO2_trmt" value="CO2_trmt"><label for="CO2_trmt">CO₂ Treatment (ppm)</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="WS_10" value="WS_10"><label for="WS_10">Wind Speed (m/s)</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction (°)</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="PAR_2" value="PAR_2"><label for="PAR_2">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="radio" name="independent" id="PREC_6" value="PREC_6"><label for="PREC_6">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Dependent:</span>
                <div class="dropdown-toggle" id="dependent-toggle">TS_0__A1</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="radio" name="dependent" id="TS_0__A1" value="TS_0__A1" checked><label for="TS_0__A1">Soil Temp 0 cm (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="TS_-5__A2" value="TS_-5__A2"><label for="TS_-5__A2">Soil Temp -5 cm (A2, °C)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="TS_-10__A3" value="TS_-10__A3"><label for="TS_-10__A3">Soil Temp -10 cm (A3, °C)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="TS_-20__A4" value="TS_-20__A4"><label for="TS_-20__A4">Soil Temp -20 cm (A4, °C)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="TS_-100__A8" value="TS_-100__A8"><label for="TS_-100__A8">Soil Temp -100 cm (A8, °C)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="TS_Hummock_A1" value="TS_Hummock_A1"><label for="TS_Hummock_A1">Hummock Temp (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="WS_10" value="WS_10"><label for="WS_10">Wind Speed (m/s)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction (°)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="PAR_2" value="PAR_2"><label for="PAR_2">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="radio" name="dependent" id="PREC_6" value="PREC_6"><label for="PREC_6">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Conditions:</span>
                <div class="dropdown-toggle" id="condition-toggle">Select Conditions</div>
                <div class="dropdown-menu" id="condition-menu">
                    <div class="dropdown-item"><input type="checkbox" id="WS_10_cond" value="WS_10"><label for="WS_10_cond">Wind Speed</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10_cond" value="WD_10"><label for="WD_10_cond">Wind Direction</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2_cond" value="PAR_2"><label for="PAR_2_cond">PAR</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6_cond" value="PREC_6"><label for="PREC_6_cond">Precipitation</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Stats:</span>
                <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                <div class="stats-panel" id="stats-panel">
                    <div id="stats-content"></div>
                </div>
            </div>
        </div>
        <div class="graph-container" id="graph-container">
            <div id="graph"></div>
        </div>
    </div>

    <script>
        const baseUrl = 'https://raw.githubusercontent.com/aime2solve/SPRUCE/main/';
        let allData = [];
        const plots = Array.from({ length: 21 }, (_, i) => i + 1);

        // Updated list of known files
        const knownFiles = [
            'WEW PLOT_04_Complete_Environ_20160826.csv',
            'WEW PLOT_06_Complete_Environ_20160826.csv',
            'WEW PLOT_08_Complete_Environ_20160826.csv',
            'WEW PLOT_10_Complete_Environ_20160826.csv',
            'WEW PLOT_21_Complete_Environ_20160826.csv'
        ];

        // Initial plot
        Plotly.newPlot('graph', [], {
            title: 'Loading SPRUCE Data...',
            plot_bgcolor: '#1A1A1A',
            paper_bgcolor: '#1A1A1A',
            font: { color: '#FFFFFF' },
            xaxis: { gridcolor: '#333333' },
            yaxis: { gridcolor: '#333333' }
        }, { responsive: true });

        // Populate plot dropdown
        function populatePlotDropdown() {
            const plotMenu = document.getElementById('plot-menu');
            plotMenu.innerHTML = '';
            plots.forEach(plot => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `plot-${plot}`;
                input.value = plot;
                input.checked = true;
                input.addEventListener('change', updateGraph);
                const label = document.createElement('label');
                label.htmlFor = `plot-${plot}`;
                label.textContent = `Plot ${plot}`;
                div.appendChild(input);
                div.appendChild(label);
                plotMenu.appendChild(div);
            });
        }

        // Fetch CSV data for a specific file
        async function fetchFileData(filename) {
            const url = `${baseUrl}${filename}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const csvText = await response.text();
                const result = Papa.parse(csvText, { header: true, dynamicTyping: true });
                const plot = parseInt(filename.match(/PLOT_(\d+)/)[1]);
                return result.data.map(row => ({ ...row, Plot: plot }));
            } catch (error) {
                console.error(`Error fetching ${filename}:`, error);
                return [];
            }
        }

        // Load all data
        async function loadData() {
            const promises = knownFiles.map(file => fetchFileData(file));
            const results = await Promise.all(promises);
            allData = results.flat();
            const loadedPlots = [...new Set(allData.map(row => row.Plot))];
            const noDataPlots = plots.filter(plot => !loadedPlots.includes(plot)).map(plot => `No data for Plot ${plot}`);
            if (allData.length === 0) {
                Plotly.newPlot('graph', [], {
                    title: 'No Data Loaded' + (noDataPlots.length ? '<br>' + noDataPlots.join('<br>') : ''),
                    plot_bgcolor: '#1A1A1A',
                    paper_bgcolor: '#1A1A1A',
                    font: { color: '#FFFFFF' }
                });
            } else {
                updateGraph();
            }
        }

        // Toggle dropdown
        function toggleDropdown(id) {
            const menu = document.getElementById(id);
            menu.classList.toggle('open');
        }

        // Update graph
        function updateGraph() {
            const selectedPlots = Array.from(document.querySelectorAll('#plot-menu input:checked')).map(input => parseInt(input.value));
            const independent = document.querySelector('#independent-menu input:checked').value;
            const dependent = document.querySelector('#dependent-menu input:checked').value;
            const conditions = Array.from(document.querySelectorAll('#condition-menu input:checked')).map(input => input.value);

            let filteredData = allData.filter(row => selectedPlots.includes(row.Plot));
            conditions.forEach(cond => {
                filteredData = filteredData.filter(row => row[cond] !== undefined && row[cond] !== null && row[cond] !== 0);
            });

            const traces = [];
            const noDataPlots = [];
            selectedPlots.forEach(plot => {
                const plotData = filteredData.filter(row => row.Plot === plot);
                if (plotData.length === 0) {
                    noDataPlots.push(`No data for Plot ${plot}`);
                    return;
                }
                const x = plotData.map(row => row[independent]).filter(v => v !== undefined && v !== null);
                const y = plotData.map(row => row[dependent]).filter(v => v !== undefined && v !== null);
                if (x.length > 0 && y.length > 0) {
                    traces.push({
                        x: x,
                        y: y,
                        mode: 'markers',
                        name: `Plot ${plot}`,
                        marker: { size: 12, color: `#${Math.floor(Math.random()*16777215).toString(16)}` }
                    });
                }
            });

            const allY = filteredData.map(row => row[dependent]).filter(v => v !== undefined && v !== null);
            const statsText = allY.length > 0 ? 
                `Mean: ${(allY.reduce((sum, val) => sum + val, 0) / allY.length).toFixed(2)}, ` +
                `Min: ${Math.min(...allY).toFixed(2)}, Max: ${Math.max(...allY).toFixed(2)}, Points: ${allY.length}` :
                'No data points';
            document.getElementById('stats-content').innerHTML = statsText;

            const layout = {
                title: `${dependent.replace(/_/g, ' ')} vs ${independent.replace(/_/g, ' ')}` + 
                       (noDataPlots.length ? '<br>' + noDataPlots.join('<br>') : ''),
                plot_bgcolor: '#1A1A1A',
                paper_bgcolor: '#1A1A1A',
                font: { color: '#FFFFFF' },
                xaxis: { title: document.querySelector(`label[for="${independent}"]`).textContent, gridcolor: '#333333' },
                yaxis: { title: document.querySelector(`label[for="${dependent}"]`).textContent, gridcolor: '#333333' },
                showlegend: true
            };

            if (traces.length === 0) {
                layout.title = 'No Data to Plot' + (noDataPlots.length ? '<br>' + noDataPlots.join('<br>') : '');
            }
            Plotly.newPlot('graph', traces, layout, { responsive: true });
        }

        // Event listeners
        document.getElementById('plot-toggle').addEventListener('click', () => toggleDropdown('plot-menu'));
        document.getElementById('independent-toggle').addEventListener('click', () => toggleDropdown('independent-menu'));
        document.getElementById('dependent-toggle').addEventListener('click', () => toggleDropdown('dependent-menu'));
        document.getElementById('condition-toggle').addEventListener('click', () => toggleDropdown('condition-menu'));
        document.getElementById('stats-toggle').addEventListener('click', () => {
            const statsPanel = document.getElementById('stats-panel');
            statsPanel.classList.toggle('open');
            document.getElementById('stats-toggle').textContent = statsPanel.classList.contains('open') ? 'Hide Stats' : 'Show Stats';
        });

        document.querySelectorAll('#independent-menu input, #dependent-menu input').forEach(input => {
            input.addEventListener('change', () => {
                if (input.name === 'independent') {
                    document.getElementById('independent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
                } else if (input.name === 'dependent') {
                    document.getElementById('dependent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
                }
                updateGraph();
            });
        });
        document.querySelectorAll('#condition-menu input').forEach(input => {
            input.addEventListener('change', updateGraph);
        });

        // Initialize
        populatePlotDropdown();
        loadData();
    </script>
</body>
</html>
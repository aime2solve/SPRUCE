<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRUCE Soil Temperature Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Lato:wght@400;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000000;
            font-family: 'Lato', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #00FFFF;
            text-align: center;
            text-shadow: 0 0 10px #00CC66, 0 0 20px #00CC66;
            padding: 3vh;
            font-family: 'Orbitron', sans-serif;
            font-size: calc(18px + 2vw);
            margin: 0;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: rgba(26, 26, 26, 0.8);
            border-right: 2px solid #00FFFF;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: fixed;
            top: 15vh;
            height: 85%;
            transition: transform 0.3s ease;
        }
        .sidebar.collapsed {
            transform: translateX(-280px);
        }
        .sidebar-tab {
            position: absolute;
            top: 0;
            right: -40px;
            width: 40px;
            height: 40px;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-left: none;
            border-radius: 0 10px 10px 0;
            color: #00FFFF;
            font-size: 18px;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 0 8px #00FFFF;
        }
        .sidebar-title {
            font-family: 'Merriweather', serif;
            font-size: 24px;
            color: #DAA520;
            text-align: center;
            text-shadow: 0 0 10px #DAA520;
        }
        .button-container {
            display: flex;
            align-items: center;
            width: 100%;
            position: relative;
        }
        .button-label {
            color: #FFFF00;
            font-size: 12px;
            margin-right: 10px;
            width: 100px;
            text-align: right;
        }
        .dropdown-toggle, #analyze-button {
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FFFF;
            font-size: 10px;
            padding: 4px 8px;
            width: calc(100% - 120px);
            text-align: left;
            cursor: pointer;
            box-shadow: 0 0 8px #00FFFF;
        }
        #analyze-button {
            text-align: center;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 110px;
            width: calc(100% - 120px);
            max-height: 0;
            overflow-y: auto;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FFFF;
            font-size: 10px;
            padding: 8px;
            transition: max-height 0.5s ease;
            visibility: hidden;
        }
        .dropdown-menu.open {
            max-height: 400px;
            visibility: visible;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            accent-color: #00FFFF;
        }
        #time-range-menu {
            padding: 10px;
        }
        #time-range-menu .dropdown-item {
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        #time-range-menu input[type="text"] {
            width: 100%;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid #00FFFF;
            color: #00FFFF;
            padding: 4px;
            margin-top: 5px;
            font-size: 10px;
        }
        .stats-panel {
            position: absolute;
            top: 100%;
            left: 110px;
            width: calc(100% - 120px);
            max-height: 0;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FF00;
            font-size: 10px;
            padding: 8px;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        .stats-panel.open {
            max-height: 200px;
        }
        .graph-container {
            flex-grow: 1;
            margin-left: 300px;
            background-color: #1A1A1A;
            height: 98%;
            transition: margin-left 0.3s ease;
        }
        .graph-container.full-width {
            margin-left: 0;
        }
        #graph {
            width: 90%;
            height: 99%;
            margin: 0.5% auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6.11/dist/plot.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
    <h1>SPRUCE Soil Temperature Dashboard</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-tab" id="sidebar-tab">></div>
            <div class="sidebar-title">SPRUCE Data Explorer</div>
            <div class="button-container">
                <span class="button-label">Plot:</span>
                <div class="dropdown-toggle" id="plot-toggle">Select Plots</div>
                <div class="dropdown-menu" id="plot-menu"></div>
            </div>
            <div class="button-container">
                <span class="button-label">Independent:</span>
                <div class="dropdown-toggle" id="independent-toggle">Target Temperature (°C)</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="Temp_target" value="Temp_target"><label for="Temp_target">Target Temperature (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_trmt" value="CO2_trmt"><label for="CO2_trmt">CO₂ Treatment (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WS_10" value="WS_10"><label for="WS_10">Wind Speed (m/s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2" value="PAR_2"><label for="PAR_2">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6" value="PREC_6"><label for="PREC_6">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Dependent:</span>
                <div class="dropdown-toggle" id="dependent-toggle">Soil Temp 0 cm (A1, °C)</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="TS_0__A1" value="TS_0__A1"><label for="TS_0__A1">Soil Temp 0 cm (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-5__A2" value="TS_-5__A2"><label for="TS_-5__A2">Soil Temp -5 cm (A2, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-10__A3" value="TS_-10__A3"><label for="TS_-10__A3">Soil Temp -10 cm (A3, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-20__A4" value="TS_-20__A4"><label for="TS_-20__A4">Soil Temp -20 cm (A4, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-100__A8" value="TS_-100__A8"><label for="TS_-100__A8">Soil Temp -100 cm (A8, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_Hummock_A1" value="TS_Hummock_A1"><label for="TS_Hummock_A1">Hummock Temp (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WS_10_dep" value="WS_10"><label for="WS_10_dep">Wind Speed (m/s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10_dep" value="WD_10"><label for="WD_10_dep">Wind Direction (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2_dep" value="PAR_2"><label for="PAR_2_dep">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6_dep" value="PREC_6"><label for="PREC_6_dep">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Conditions:</span>
                <div class="dropdown-toggle" id="condition-toggle">Select Conditions</div>
                <div class="dropdown-menu" id="condition-menu">
                    <div class="dropdown-item"><input type="checkbox" id="WS_10_cond" value="WS_10"><label for="WS_10_cond">Wind Speed</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10_cond" value="WD_10"><label for="WD_10_cond">Wind Direction</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2_cond" value="PAR_2"><label for="PAR_2_cond">PAR</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6_cond" value="PREC_6"><label for="PREC_6_cond">Precipitation</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Time Range:</span>
                <div class="dropdown-toggle" id="time-range-toggle">Select Time Range</div>
                <div class="dropdown-menu" id="time-range-menu">
                    <div class="dropdown-item">
                        <label for="start-date">Start Date:</label>
                        <input type="text" id="start-date" placeholder="YYYY-MM-DD">
                    </div>
                    <div class="dropdown-item">
                        <label for="end-date">End Date:</label>
                        <input type="text" id="end-date" placeholder="YYYY-MM-DD">
                    </div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Stats:</span>
                <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                <div class="stats-panel" id="stats-panel">
                    <div id="stats-content"></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Analyze:</span>
                <div id="analyze-button">Analyze</div>
            </div>
        </div>
        <div class="graph-container" id="graph-container">
            <div id="graph"></div>
        </div>
    </div>

   <script>
    // Ensure Observable Plot is loaded
    if (typeof Plot === 'undefined') {
        console.error('Observable Plot library not loaded!');
    } else {
        console.log('Observable Plot loaded successfully');
    }

    let allData = [];
    const plots = Array.from({ length: 21 }, (_, i) => i + 1);
    const dataUrl = 'https://raw.githubusercontent.com/aime2solve/SPRUCE/main/spruce_daily.json';
    let startDate = null;
    let endDate = null;
    let dataLoaded = false;

    document.getElementById('graph').innerHTML = '';
    const welcome = document.createElement('div');
    welcome.textContent = 'Welcome to SPRUCE!\nChoose variables and conditions to analyze';
    welcome.style.cssText = 'color: #FFFFFF; font-family: Orbitron, sans-serif; font-size: 16px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 0 10px #00CC66';
    document.getElementById('graph').appendChild(welcome);

    function populatePlotDropdown() {
        const plotMenu = document.getElementById('plot-menu');
        plotMenu.innerHTML = '';
        plots.forEach(plot => {
            const div = document.createElement('div');
            div.className = 'dropdown-item';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `plot-${plot}`;
            input.value = plot;
            input.checked = true;
            input.addEventListener('change', () => console.log(`Plot ${plot} toggled`));
            const label = document.createElement('label');
            label.htmlFor = `plot-${plot}`;
            label.textContent = `Plot ${plot}`;
            div.appendChild(input);
            div.appendChild(label);
            plotMenu.appendChild(div);
        });
    }

    async function loadData() {
        if (dataLoaded) return;
        try {
            console.log('Fetching data from:', dataUrl);
            const response = await fetch(dataUrl);
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            allData = await response.json();
            console.log(`Loaded ${allData.length} rows`);
            allData.forEach(row => {
                row.TIMESTAMP = new Date(row.TIMESTAMP);
            });
            console.log('Sample data (first row):', allData[0]);
            dataLoaded = true;
            updateGraph();
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('graph').innerHTML = 'Error loading data';
        }
    }

    function toggleDropdown(id) {
        console.log(`Toggling dropdown: ${id}`);
        const menu = document.getElementById(id);
        if (menu) menu.classList.toggle('open');
        else console.error(`Dropdown menu not found: ${id}`);
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const graphContainer = document.getElementById('graph-container');
        const tab = document.getElementById('sidebar-tab');
        sidebar.classList.toggle('collapsed');
        graphContainer.classList.toggle('full-width');
        tab.textContent = sidebar.classList.contains('collapsed') ? '<' : '>';
        if (dataLoaded) Plot.resize(document.getElementById('graph').firstChild);
    }

    function enforceSingleSelection(groupId, changedId) {
        const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            if (checkbox.id !== changedId && checkbox.checked) checkbox.checked = false;
        });
    }

    function updateGraph() {
        document.getElementById('graph').innerHTML = '';
        if (!dataLoaded) {
            document.getElementById('graph').innerHTML = 'Please click Analyze to load data';
            return;
        }

        if (typeof Plot === 'undefined') {
            console.error('Plot object not available - library issue');
            document.getElementById('graph').innerHTML = 'Plotting library not loaded';
            return;
        }

        const selectedPlots = Array.from(document.querySelectorAll('#plot-menu input:checked')).map(input => parseInt(input.value));
        const independent = Array.from(document.querySelectorAll('#independent-menu input:checked'))[0]?.value || 'Temp_target';
        const dependent = Array.from(document.querySelectorAll('#dependent-menu input:checked'))[0]?.value || 'TS_0__A1';
        const conditions = Array.from(document.querySelectorAll('#condition-menu input:checked')).map(input => input.value);

        let workingData = allData.filter(row => selectedPlots.includes(row.Plot));
        if (startDate || endDate) {
            workingData = workingData.filter(row => {
                const rowDate = row.TIMESTAMP;
                return (!startDate || rowDate >= startDate) && (!endDate || rowDate <= endDate);
            });
        }
        conditions.forEach(cond => {
            workingData = workingData.filter(row => row[cond] !== undefined && row[cond] !== null && row[cond] !== 0);
        });

        console.log(`Plotting ${workingData.length} rows with ${independent} vs ${dependent}`);
        console.log('Sample working data (first row):', workingData[0]);

        const plot = Plot.plot({
            width: document.getElementById('graph').clientWidth,
            height: document.getElementById('graph').clientHeight,
            style: { background: '#1A1A1A', color: '#FFFFFF', fontFamily: 'Lato, sans-serif' },
            x: { label: document.querySelector(`label[for="${independent}"]`)?.textContent || independent, grid: true, type: 'linear' },
            y: { label: document.querySelector(`label[for="${dependent}"]`)?.textContent || dependent, grid: true, type: 'linear' },
            marks: [
                Plot.dot(workingData, {
                    x: independent,
                    y: dependent,
                    fill: d => `#${Math.floor(Math.random()*16777215).toString(16)}`,
                    r: 6,
                    title: d => `Plot ${d.Plot}\n${independent}: ${d[independent]}\n${dependent}: ${d[dependent]}`
                })
            ]
        });
        document.getElementById('graph').appendChild(plot);

        const allY = workingData.map(row => row[dependent]).filter(v => v !== undefined && v !== null);
        const statsText = allY.length > 0 ? 
            `Mean: ${(allY.reduce((sum, val) => sum + val, 0) / allY.length).toFixed(2)}, ` +
            `Min: ${Math.min(...allY).toFixed(2)}, Max: ${Math.max(...allY).toFixed(2)}, Points: ${allY.length}` :
            'No data points';
        document.getElementById('stats-content').innerHTML = statsText;
    }

    document.getElementById('sidebar-tab').addEventListener('click', toggleSidebar);
    document.getElementById('plot-toggle').addEventListener('click', () => {
        console.log('Plot toggle clicked');
        toggleDropdown('plot-menu');
    });
    document.getElementById('independent-toggle').addEventListener('click', () => {
        console.log('Independent toggle clicked');
        toggleDropdown('independent-menu');
    });
    document.getElementById('dependent-toggle').addEventListener('click', () => {
        console.log('Dependent toggle clicked');
        toggleDropdown('dependent-menu');
    });
    document.getElementById('condition-toggle').addEventListener('click', () => {
        console.log('Condition toggle clicked');
        toggleDropdown('condition-menu');
    });
    document.getElementById('time-range-toggle').addEventListener('click', () => {
        console.log('Time range toggle clicked');
        toggleDropdown('time-range-menu');
    });
    document.getElementById('stats-toggle').addEventListener('click', () => {
        console.log('Stats toggle clicked');
        const statsPanel = document.getElementById('stats-panel');
        statsPanel.classList.toggle('open');
        document.getElementById('stats-toggle').textContent = statsPanel.classList.contains('open') ? 'Hide Stats' : 'Show Stats';
    });
    document.getElementById('analyze-button').addEventListener('click', () => {
        console.log('Analyze button clicked');
        loadData();
    });

    document.querySelectorAll('#independent-menu input').forEach(input => {
        input.addEventListener('change', () => {
            enforceSingleSelection('independent-menu', input.id);
            document.getElementById('independent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
        });
        if (input.id === 'Temp_target') input.checked = true;
    });

    document.querySelectorAll('#dependent-menu input').forEach(input => {
        input.addEventListener('change', () => {
            enforceSingleSelection('dependent-menu', input.id);
            document.getElementById('dependent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
        });
        if (input.id === 'TS_0__A1') input.checked = true;
    });

    document.querySelectorAll('#condition-menu input').forEach(input => {
        input.addEventListener('change', () => console.log(`Condition ${input.value} toggled`));
    });

    flatpickr('#start-date', {
        dateFormat: 'Y-m-d',
        onChange: (selectedDates) => {
            startDate = selectedDates[0];
            document.getElementById('time-range-toggle').textContent = 
                `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
        }
    });

    flatpickr('#end-date', {
        dateFormat: 'Y-m-d',
        onChange: (selectedDates) => {
            endDate = selectedDates[0];
            document.getElementById('time-range-toggle').textContent = 
                `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
        }
    });

    populatePlotDropdown();
</script>            document.getElementById('time-range-toggle').textContent = 
                `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
        }
    });

    flatpickr('#end-date', {
        dateFormat: 'Y-m-d',
        onChange: (selectedDates) => {
            endDate = selectedDates[0];
            document.getElementById('time-range-toggle').textContent = 
                `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
        }
    });

    populatePlotDropdown();
</script>atpickr('#end-date', {
            dateFormat: 'Y-m-d',
            onChange: (selectedDates) => {
                endDate = selectedDates[0];
                document.getElementById('time-range-toggle').textContent = 
                    `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
            }
        });

        populatePlotDropdown();
    </script>
</body>
</html>
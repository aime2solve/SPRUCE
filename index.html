<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRUCE Soil Temperature Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Lato:wght@400;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #000000;
            font-family: 'Lato', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #00FFFF;
            text-align: center;
            text-shadow: 0 0 10px #00CC66, 0 0 20px #00CC66;
            padding: 3vh;
            font-family: 'Orbitron', sans-serif;
            font-size: calc(18px + 2vw);
            margin: 0;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: rgba(26, 26, 26, 0.8);
            border-right: 2px solid #00FFFF;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: fixed;
            top: 15vh;
            height: 85%;
            transition: transform 0.3s ease;
        }
        .sidebar.collapsed {
            transform: translateX(-280px);
        }
        .sidebar-tab {
            position: absolute;
            top: 0;
            right: -40px;
            width: 40px;
            height: 40px;
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-left: none;
            border-radius: 0 10px 10px 0;
            color: #00FFFF;
            font-size: 18px;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 0 8px #00FFFF;
        }
        .sidebar-title {
            font-family: 'Merriweather', serif;
            font-size: 24px;
            color: #DAA520;
            text-align: center;
            text-shadow: 0 0 10px #DAA520;
        }
        .button-container {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .button-label {
            color: #FFFF00;
            font-size: 12px;
            margin-right: 10px;
            width: 100px;
            text-align: right;
        }
        .dropdown-toggle {
            background: rgba(26, 26, 26, 0.8);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FFFF;
            font-size: 10px;
            padding: 4px 8px;
            width: calc(100% - 120px);
            text-align: left;
            cursor: pointer;
            box-shadow: 0 0 8px #00FFFF;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 110px;
            width: calc(100% - 120px);
            max-height: 0;
            overflow-y: auto;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FFFF;
            font-size: 10px;
            padding: 8px;
            transition: max-height 0.5s ease;
        }
        .dropdown-menu.open {
            display: block;
            max-height: 400px;
        }
        .dropdown-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            accent-color: #00FFFF;
        }
        #time-range-menu {
            padding: 10px;
        }
        #time-range-menu .dropdown-item {
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        #time-range-menu input[type="text"] {
            width: 100%;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid #00FFFF;
            color: #00FFFF;
            padding: 4px;
            margin-top: 5px;
            font-size: 10px;
        }
        .stats-panel {
            display: none;
            width: calc(100% - 120px);
            max-height: 200px;
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #00FFFF;
            border-radius: 10px;
            color: #00FF00;
            font-size: 10px;
            padding: 8px;
            margin-left: auto;
            margin-top: 5px;
        }
        .stats-panel.open {
            display: block;
        }
        .graph-container {
            flex-grow: 1;
            margin-left: 300px;
            background-color: #1A1A1A;
            height: 98%;
            transition: margin-left 0.3s ease;
        }
        .graph-container.full-width {
            margin-left: 0;
        }
        #graph {
            width: 90%;
            height: 99%;
            margin: 0.5% auto;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
    <h1>SPRUCE Soil Temperature Dashboard</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-tab" id="sidebar-tab">&gt;</div>
            <div class="sidebar-title">SPRUCE Data Explorer</div>
            <div class="button-container">
                <span class="button-label">Plot:</span>
                <div class="dropdown-toggle" id="plot-toggle">Select Plots</div>
                <div class="dropdown-menu" id="plot-menu"></div>
            </div>
            <div class="button-container">
                <span class="button-label">Independent:</span>
                <div class="dropdown-toggle" id="independent-toggle">Target Temperature (°C)</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="Temp_target" value="Temp_target"><label for="Temp_target">Target Temperature (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_trmt" value="CO2_trmt"><label for="CO2_trmt">CO₂ Treatment (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WS_10" value="WS_10"><label for="WS_10">Wind Speed (m/s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2" value="PAR_2"><label for="PAR_2">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6" value="PREC_6"><label for="PREC_6">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Dependent:</span>
                <div class="dropdown-toggle" id="dependent-toggle">Soil Temp 0 cm (A1, °C)</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="TS_0__A1" value="TS_0__A1"><label for="TS_0__A1">Soil Temp 0 cm (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-5__A2" value="TS_-5__A2"><label for="TS_-5__A2">Soil Temp -5 cm (A2, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-10__A3" value="TS_-10__A3"><label for="TS_-10__A3">Soil Temp -10 cm (A3, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-20__A4" value="TS_-20__A4"><label for="TS_-20__A4">Soil Temp -20 cm (A4, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-100__A8" value="TS_-100__A8"><label for="TS_-100__A8">Soil Temp -100 cm (A8, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_Hummock_A1" value="TS_Hummock_A1"><label for="TS_Hummock_A1">Hummock Temp (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WS_ Bind 10" value="WS_10"><label for="WS_10">Wind Speed (m/s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2_dep" value="PAR_2"><label for="PAR_2_dep">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6_dep" value="PREC_6"><label for="PREC_6_dep">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Conditions:</span>
                <div class="dropdown-toggle" id="condition-toggle">Select Conditions</div>
                <div class="dropdown-menu" id="condition-menu">
                    <div class="dropdown-item"><input type="checkbox" id="WS_10_cond" value="WS_10"><label for="WS_10_cond">Wind Speed</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10_cond" value="WD_10"><label for="WD_10_cond">Wind Direction</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2_cond" value="PAR_2"><label for="PAR_2_cond">PAR</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6_cond" value="PREC_6"><label for="PREC_6_cond">Precipitation</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Time Range:</span>
                <div class="dropdown-toggle" id="time-range-toggle">Select Time Range</div>
                <div class="dropdown-menu" id="time-range-menu">
                    <div class="dropdown-item">
                        <label for="start-date">Start Date:</label>
                        <input type="text" id="start-date" placeholder="YYYY-MM-DD">
                    </div>
                    <div class="dropdown-item">
                        <label for="end-date">End Date:</label>
                        <input type="text" id="end-date" placeholder="YYYY-MM-DD">
                    </div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Stats:</span>
                <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                <div class="stats-panel" id="stats-panel">
                    <div id="stats-content"></div>
                </div>
            </div>
        </div>
        <div class="graph-container" id="graph-container">
            <div id="graph"></div>
        </div>
    </div>

   <script>
    const baseUrl = 'https://raw.githubusercontent.com/aime2solve/SPRUCE/main/';
    let allData = [];
    let filteredData = [];
    const plots = Array.from({ length: 21 }, (_, i) => i + 1);
    const knownFiles = [
        'WEW PLOT_04_Complete_Environ_20160826.csv',
        'WEW PLOT_06_Complete_Environ_20160826.csv',
        'WEW PLOT_08_Complete_Environ_20160826.csv',
        'WEW PLOT_10_Complete_Environ_20160826.csv',
        'WEW PLOT_21_Complete_Environ_20160826.csv'
    ];
    let startDate = null;
    let endDate = null;

    Plotly.newPlot('graph', [], {
        title: 'Loading SPRUCE Data...',
        plot_bgcolor: '#1A1A1A',
        paper_bgcolor: '#1A1A1A',
        font: { color: '#FFFFFF' },
        xaxis: { gridcolor: '#333333' },
        yaxis: { gridcolor: '#333333' }
    }, { responsive: true });

    function populatePlotDropdown() {
        const plotMenu = document.getElementById('plot-menu');
        plotMenu.innerHTML = '';
        plots.forEach(plot => {
            const div = document.createElement('div');
            div.className = 'dropdown-item';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `plot-${plot}`;
            input.value = plot;
            input.checked = true;
            input.addEventListener('change', debounceUpdateGraph);
            const label = document.createElement('label');
            label.htmlFor = `plot-${plot}`;
            label.textContent = `Plot ${plot}`;
            div.appendChild(input);
            div.appendChild(label);
            plotMenu.appendChild(div);
        });
    }

    async function fetchFileData(filename) {
        const url = `${baseUrl}${filename}`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            const csvText = await response.text();
            const result = Papa.parse(csvText, { header: true, dynamicTyping: true });
            const plot = parseInt(filename.match(/PLOT_(\d+)/)[1]);
            console.log(`Loaded ${filename}: ${result.data.length} rows`);
            return result.data.map(row => ({ ...row, Plot: plot, TIMESTAMP: row.TIMESTAMP }));
        } catch (error) {
            console.error(`Error fetching ${filename}:`, error);
            return [];
        }
    }

    async function loadData() {
        const promises = knownFiles.map(file => fetchFileData(file));
        const results = await Promise.all(promises);
        allData = results.flat();
        console.log(`Total rows loaded: ${allData.length}`);
        filteredData = allData; // Initial filter
        updateGraph();
    }

    function toggleDropdown(id) {
        const menu = document.getElementById(id);
        menu.classList.toggle('open');
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const graphContainer = document.getElementById('graph-container');
        const tab = document.getElementById('sidebar-tab');
        sidebar.classList.toggle('collapsed');
        graphContainer.classList.toggle('full-width');
        tab.textContent = sidebar.classList.contains('collapsed') ? '<' : '>';
        Plotly.Plots.resize('graph');
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    const debounceUpdateGraph = debounce(updateGraph, 300);

    function enforceSingleSelection(groupId, changedId) {
        const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]`);
        checkboxes.forEach(checkbox => {
            if (checkbox.id !== changedId && checkbox.checked) {
                checkbox.checked = false;
            }
        });
    }

    function updateGraph() {
        const selectedPlots = Array.from(document.querySelectorAll('#plot-menu input:checked')).map(input => parseInt(input.value));
        const independent = Array.from(document.querySelectorAll('#independent-menu input:checked'))[0]?.value || 'Temp_target';
        const dependent = Array.from(document.querySelectorAll('#dependent-menu input:checked'))[0]?.value || 'TS_0__A1';
        const conditions = Array.from(document.querySelectorAll('#condition-menu input:checked')).map(input => input.value);

        // Pre-filter data once
        let workingData = allData.filter(row => selectedPlots.includes(row.Plot));
        if (startDate || endDate) {
            workingData = workingData.filter(row => {
                const rowDate = new Date(row.TIMESTAMP);
                return (!startDate || rowDate >= startDate) && (!endDate || rowDate <= endDate);
            });
        }
        conditions.forEach(cond => {
            workingData = workingData.filter(row => row[cond] !== undefined && row[cond] !== null && row[cond] !== 0);
        });

        // Limit total points to 5000, distributing across plots
        const maxPoints = 5000;
        const pointsPerPlot = Math.floor(maxPoints / selectedPlots.length) || 1;
        const traces = [];
        const noDataPlots = [];
        selectedPlots.forEach(plot => {
            const plotData = workingData.filter(row => row.Plot === plot);
            if (plotData.length === 0) {
                noDataPlots.push(`No data for Plot ${plot}`);
                return;
            }
            const limitedData = plotData.slice(0, pointsPerPlot);
            const x = limitedData.map(row => row[independent]).filter(v => v !== undefined && v !== null);
            const y = limitedData.map(row => row[dependent]).filter(v => v !== undefined && v !== null);
            if (x.length > 0 && y.length > 0) {
                traces.push({
                    x: x,
                    y: y,
                    mode: 'markers',
                    name: `Plot ${plot}`,
                    marker: { size: 12, color: `#${Math.floor(Math.random()*16777215).toString(16)}` }
                });
            }
        });

        const allY = workingData.map(row => row[dependent]).filter(v => v !== undefined && v !== null);
        const statsText = allY.length > 0 ? 
            `Mean: ${(allY.reduce((sum, val) => sum + val, 0) / allY.length).toFixed(2)}, ` +
            `Min: ${Math.min(...allY).toFixed(2)}, Max: ${Math.max(...allY).toFixed(2)}, Points: ${allY.length}` :
            'No data points';
        document.getElementById('stats-content').innerHTML = statsText;

        const layout = {
            title: `${dependent.replace(/_/g, ' ')} vs ${independent.replace(/_/g, ' ')}` + 
                   (noDataPlots.length ? '<br>' + noDataPlots.join('<br>') : ''),
            plot_bgcolor: '#1A1A1A',
            paper_bgcolor: '#1A1A1A',
            font: { color: '#FFFFFF' },
            xaxis: { title: document.querySelector(`label[for="${independent}"]`)?.textContent || independent, gridcolor: '#333333' },
            yaxis: { title: document.querySelector(`label[for="${dependent}"]`)?.textContent || dependent, gridcolor: '#333333' },
            showlegend: true
        };

        if (traces.length === 0) {
            layout.title = 'No Data to Plot' + (noDataPlots.length ? '<br>' + noDataPlots.join('<br>') : '');
        }
        Plotly.newPlot('graph', traces, layout, { responsive: true }).catch(err => console.error('Plotly error:', err));
    }

    document.getElementById('sidebar-tab').addEventListener('click', toggleSidebar);
    document.getElementById('plot-toggle').addEventListener('click', () => toggleDropdown('plot-menu'));
    document.getElementById('independent-toggle').addEventListener('click', () => toggleDropdown('independent-menu'));
    document.getElementById('dependent-toggle').addEventListener('click', () => toggleDropdown('dependent-menu'));
    document.getElementById('condition-toggle').addEventListener('click', () => toggleDropdown('condition-menu'));
    document.getElementById('time-range-toggle').addEventListener('click', () => toggleDropdown('time-range-menu'));
    document.getElementById('stats-toggle').addEventListener('click', () => {
        const statsPanel = document.getElementById('stats-panel');
        statsPanel.classList.toggle('open');
        document.getElementById('stats-toggle').textContent = statsPanel.classList.contains('open') ? 'Hide Stats' : 'Show Stats';
    });

    document.querySelectorAll('#independent-menu input').forEach(input => {
        input.addEventListener('change', () => {
            enforceSingleSelection('independent-menu', input.id);
            document.getElementById('independent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
            debounceUpdateGraph();
        });
        if (input.id === 'Temp_target') input.checked = true; // Default
    });

    document.querySelectorAll('#dependent-menu input').forEach(input => {
        input.addEventListener('change', () => {
            enforceSingleSelection('dependent-menu', input.id);
            document.getElementById('dependent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
            debounceUpdateGraph();
        });
        if (input.id === 'TS_0__A1') input.checked = true; // Default
    });

    document.querySelectorAll('#condition-menu input').forEach(input => {
        input.addEventListener('change', debounceUpdateGraph);
    });

    flatpickr('#start-date', {
        dateFormat: 'Y-m-d',
        onChange: (selectedDates) => {
            startDate = selectedDates[0];
            document.getElementById('time-range-toggle').textContent = 
                `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
            debounceUpdateGraph();
        }
    });

    flatpickr('#end-date', {
        dateFormat: 'Y-m-d',
        onChange: (selectedDates) => {
            endDate = selectedDates[0];
            document.getElementById('time-range-toggle').textContent = 
                `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
            debounceUpdateGraph();
        }
    });

    populatePlotDropdown();
    loadData();
</script>   flatpickr('#end-date', {
            dateFormat: 'Y-m-d',
            onChange: (selectedDates) => {
                endDate = selectedDates[0];
                document.getElementById('time-range-toggle').textContent = 
                    `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
                debounceUpdateGraph();
            }
        });

        populatePlotDropdown();
        loadData();
    </script>
</body>
</html>
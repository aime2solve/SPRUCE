<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Biospheromics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Lato:wght@400;700&family=Exo+2:wght@700&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            width: 100vw; 
            background-color: #000000; 
            font-family: 'Lato', sans-serif; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        h1 { 
            color: #00FFFF; 
            text-align: center; 
            padding: 2vh; 
            font-family: 'Orbitron', sans-serif; 
            font-size: calc(16px + 1.5vw); 
            margin: 0; 
            text-shadow: 2px 2px 4px #00CC66, -2px -2px 4px #00CC66, 0 0 10px #00FFFF; 
            flex-shrink: 0; 
        }
        .container { 
            display: flex; 
            flex-grow: 1; 
            overflow: hidden; 
            height: calc(100vh - 4vh); 
        }
        .sidebar { 
            width: 250px; 
            background: rgba(26, 26, 26, 0.8); 
            border-right: 2px solid #00FFFF; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            position: fixed; 
            top: 0; /* Start at top */
            height: calc(100vh - 2vh); /* Slightly shorter than full height */
            transition: transform 0.3s ease; 
            z-index: 10; 
        }
        .sidebar.collapsed { transform: translateX(-230px); }
        .sidebar-tab { 
            position: absolute; 
            top: 2vh; /* Align with title height */
            right: -40px; 
            width: 40px; 
            height: 40px; 
            background: rgba(26, 26, 26, 0.8); 
            border: 2px solid #00FFFF; 
            border-left: none; 
            border-radius: 0 10px 10px 0; 
            color: #00FFFF; 
            font-size: 18px; 
            line-height: 36px; 
            text-align: center; 
            cursor: pointer; 
            box-shadow: 0 0 8px #00FFFF; 
        }
        .sidebar-title { font-family: 'Exo 2', sans-serif; font-size: 20px; color: #DAA520; text-align: center; text-shadow: 0 0 10px #DAA520; line-height: 1.2; margin-top: 4vh; }
        .sidebar-title span { display: block; font-size: 14px; }
        .button-container { display: flex; align-items: center; width: 100%; position: relative; }
        .button-label { color: #FFFF00; font-size: 12px; margin-right: 10px; width: 100px; text-align: right; padding-left: 10px; }
        .dropdown-toggle, #analyze-button { 
            background: rgba(26, 26, 26, 0.8); 
            border: 2px solid #00FFFF; 
            border-radius: 10px; 
            color: #00FFFF; 
            font-size: 10px; 
            padding: 4px 8px; 
            width: calc(100% - 120px); 
            text-align: left; 
            cursor: pointer; 
            box-shadow: 0 0 8px #00FFFF; 
        }
        #analyze-button { text-align: center; }
        .dropdown-menu { 
            position: absolute; 
            top: 100%; 
            left: 110px; 
            width: calc(100% - 120px); 
            max-height: 200px; 
            overflow-y: auto; 
            background: rgba(26, 26, 26, 0.9); 
            border: 2px solid #00FFFF; 
            border-radius: 10px; 
            color: #00FFFF; 
            font-size: 10px; 
            padding: 8px; 
            transition: max-height 0.5s ease; 
            visibility: hidden; 
            z-index: 10; 
        }
        .dropdown-menu.open { max-height: 200px; visibility: visible; }
        .dropdown-item { display: flex; align-items: center; margin-bottom: 3px; }
        #dependent-menu .dropdown-item label { margin-left: 5px; }
        #condition-menu .dropdown-item { flex-direction: column; align-items: flex-start; margin-bottom: 8px; }
        #condition-menu .range-options { margin-left: 20px; margin-top: 5px; }
        #condition-menu .range-options .dropdown-item { margin-bottom: 3px; }
        #stats-menu #stats-content { color: #00FF00; font-family: 'VT323', monospace; font-size: 12px; }
        #time-range-menu { padding: 10px; }
        #time-range-menu .dropdown-item { flex-direction: column; align-items: flex-start; margin-bottom: 10px; }
        #time-range-menu input[type="text"] { width: 100%; background: rgba(26, 26, 26, 0.8); border: 1px solid #00FFFF; color: #00FFFF; padding: 4px; margin-top: 5px; font-size: 10px; }
        .graph-container { 
            flex-grow: 1; 
            margin-left: 250px; 
            background-color: #1A1A1A; 
            height: calc(100vh - 6vh); /* Tighten bottom */
            transition: margin-left 0.3s ease; 
            position: relative; 
            z-index: 1; 
            overflow: hidden; 
        }
        .graph-container.full-width { margin-left: 0; }
        #graph { 
            width: 100%; 
            height: 100%; 
            min-width: 320px; 
            min-height: 240px; 
        }
        .legend-tab { 
            position: absolute; 
            top: 50px; /* Below Plotly toolbar (~40px) */
            right: 10px; 
            background: rgba(26, 26, 26, 0.8); 
            border: 2px solid #00FFFF; 
            border-radius: 5px; 
            color: #00FFFF; 
            padding: 5px 10px; 
            cursor: pointer; 
            z-index: 5; 
        }
    </style>
</head>
<body>
    <h1>Comparative Biospheromics Dashboard</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-tab" id="sidebar-tab"><</div>
            <div class="sidebar-title">SPRUCE<br><span>Data Explorer</span></div>
            <div class="button-container">
                <span class="button-label">Plot:</span>
                <div class="dropdown-toggle" id="plot-toggle">Select Plots</div>
                <div class="dropdown-menu" id="plot-menu"></div>
            </div>
            <div class="button-container">
                <span class="button-label">Independent:</span>
                <div class="dropdown-toggle" id="independent-toggle">Target Temperature (°C)</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="Temp_target" value="Temp_target" checked><label for="Temp_target">Target Temperature (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_trmt" value="CO2_trmt"><label for="CO2_trmt">CO₂ Treatment (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TIMESTAMP" value="TIMESTAMP"><label for="TIMESTAMP">Time</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Dependent:</span>
                <div class="dropdown-toggle" id="dependent-toggle">Select Dependent</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="TS_0" value="TS_0"><label for="TS_0" style="color: #00FFFF;">Soil Temp 0 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_5" value="TS_5"><label for="TS_5" style="color: #FFFF00;">Soil Temp 5 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_10" value="TS_10"><label for="TS_10" style="color: #FF00FF;">Soil Temp 10 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_20" value="TS_20"><label for="TS_20" style="color: #00FF00;">Soil Temp 20 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_30" value="TS_30"><label for="TS_30" style="color: #FF0000;">Soil Temp 30 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_40" value="TS_40"><label for="TS_40" style="color: #0000FF;">Soil Temp 40 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_50" value="TS_50"><label for="TS_50" style="color: #FFA500;">Soil Temp 50 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_100" value="TS_100"><label for="TS_100" style="color: #800080;">Soil Temp 100 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_200" value="TS_200"><label for="TS_200" style="color: #008080;">Soil Temp 200 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TA_2_0" value="TA_2_0"><label for="TA_2_0" style="color: #FF6347;">Ambient Temp 2m (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="RH_2_0" value="RH_2_0"><label for="RH_2_0" style="color: #4682B4;">Relative Humidity 2m (%)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WS_10" value="WS_10"><label for="WS_10" style="color: #FFD700;">Wind Speed 10m (m/s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10" value="WD_10"><label for="WD_10" style="color: #6A5ACD;">Wind Direction 10m (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2" value="PAR_2"><label for="PAR_2" style="color: #20B2AA;">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6" value="PREC_6"><label for="PREC_6" style="color: #DAA520;">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Conditions:</span>
                <div class="dropdown-toggle" id="condition-toggle">Select Conditions</div>
                <div class="dropdown-menu" id="condition-menu">
                    <div class="dropdown-item">
                        <input type="checkbox" id="WS_10_cond" value="WS_10" checked><label for="WS_10_cond">Wind Speed (m/s)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="WS_10_0_2" value="0-2" checked><label for="WS_10_0_2">0-2</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WS_10_2_5" value="2-5" checked><label for="WS_10_2_5">2-5</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WS_10_5_plus" value="5+" checked><label for="WS_10_5_plus">5+</label></div>
                        </div>
                    </div>
                    <div class="dropdown-item">
                        <input type="checkbox" id="WD_10_cond" value="WD_10" checked><label for="WD_10_cond">Wind Direction (°)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="WD_10_0_90" value="0-90" checked><label for="WD_10_0_90">0-90</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WD_10_90_180" value="90-180" checked><label for="WD_10_90_180">90-180</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WD_10_180_360" value="180-360" checked><label for="WD_10_180_360">180-360</label></div>
                        </div>
                    </div>
                    <div class="dropdown-item">
                        <input type="checkbox" id="PAR_2_cond" value="PAR_2" checked><label for="PAR_2_cond">PAR (µmol/m²s)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="PAR_2_0_50" value="0-50" checked><label for="PAR_2_0_50">0-50</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PAR_2_50_100" value="50-100" checked><label for="PAR_2_50_100">50-100</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PAR_2_100_plus" value="100+" checked><label for="PAR_2_100_plus">100+</label></div>
                        </div>
                    </div>
                    <div class="dropdown-item">
                        <input type="checkbox" id="PREC_6_cond" value="PREC_6" checked><label for="PREC_6_cond">Precipitation (mm)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="PREC_6_0_1" value="0-1" checked><label for="PREC_6_0_1">0-1</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PREC_6_1_5" value="1-5" checked><label for="PREC_6_1_5">1-5</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PREC_6_5_plus" value="5+" checked><label for="PREC_6_5_plus">5+</label></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Time Range:</span>
                <div class="dropdown-toggle" id="time-range-toggle">Select Time Range</div>
                <div class="dropdown-menu" id="time-range-menu">
                    <div class="dropdown-item"><label for="start-date">Start Date:</label><input type="text" id="start-date" placeholder="YYYY-MM-DD"></div>
                    <div class="dropdown-item"><label for="end-date">End Date:</label><input type="text" id="end-date" placeholder="YYYY-MM-DD"></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Stats:</span>
                <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                <div class="dropdown-menu" id="stats-menu">
                    <div id="stats-content"></div>
                    <div class="dropdown-item">
                        <input type="checkbox" id="show-fit" checked><label for="show-fit">Show Fit & Stats on Chart</label>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Chart Type:</span>
                <div class="dropdown-toggle" id="chart-type-toggle">Scatter</div>
                <div class="dropdown-menu" id="chart-type-menu">
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="scatter" value="scatter" checked><label for="scatter">Scatter</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="line" value="line"><label for="line">Line</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="bar" value="bar"><label for="bar">Bar</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="area" value="area"><label for="area">Area</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="box" value="box"><label for="box">Box</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Analyze:</span>
                <div id="analyze-button">Analyze</div>
            </div>
        </div>
        <div class="graph-container" id="graph-container">
            <div id="graph"></div>
            <div class="legend-tab" id="legend-tab">Legend</div>
        </div>
    </div>

    <script>
        let allData = [];
        const plots = Array.from({ length: 21 }, (_, i) => i + 1);
        const dataUrl = 'https://raw.githubusercontent.com/aime2solve/SPRUCE/main/spruce_daily.json';
        let startDate = null;
        let endDate = null;
        let dataLoaded = false;
        const colors = ['#00FFFF', '#FFFF00', '#FF00FF', '#00FF00', '#FF0000', '#0000FF', '#FFA500', '#800080', '#008080', '#FF6347', '#4682B4', '#FFD700', '#6A5ACD', '#20B2AA', '#DAA520'];
        let legendVisible = true;

        function populatePlotDropdown() {
            const plotMenu = document.getElementById('plot-menu');
            plotMenu.innerHTML = '';
            plots.forEach(plot => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `plot-${plot}`;
                input.value = plot;
                input.checked = false;
                const label = document.createElement('label');
                label.htmlFor = `plot-${plot}`;
                label.textContent = `Plot ${plot}`;
                div.appendChild(input);
                div.appendChild(label);
                plotMenu.appendChild(div);
            });
        }

        async function loadData() {
            try {
                console.log('Fetching data from:', dataUrl);
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                allData = await response.json();
                console.log(`Loaded ${allData.length} rows`);
                console.log('Sample row:', JSON.stringify(allData[0], null, 2));
                console.log('Available keys:', Object.keys(allData[0]));
                allData = allData.filter(row => {
                    try {
                        row.TIMESTAMP = new Date(row.TIMESTAMP);
                        return !isNaN(row.TIMESTAMP);
                    } catch (e) {
                        console.warn('Invalid TIMESTAMP in row:', row);
                        return false;
                    }
                });
                console.log(`Rows after TIMESTAMP filter: ${allData.length}`);
                dataLoaded = true;
                updateGraph();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('graph').innerHTML = 'Error loading data';
            }
        }

        function toggleDropdown(id) {
            console.log(`Toggling dropdown: ${id}`);
            const menu = document.getElementById(id);
            if (menu) menu.classList.toggle('open');
        }

        function toggleSidebar() {
            console.log('Toggling sidebar');
            const sidebar = document.getElementById('sidebar');
            const graphContainer = document.getElementById('graph-container');
            const tab = document.getElementById('sidebar-tab');
            sidebar.classList.toggle('collapsed');
            graphContainer.classList.toggle('full-width');
            tab.textContent = sidebar.classList.contains('collapsed') ? '>' : '<';
            if (dataLoaded && typeof Plotly !== 'undefined') {
                Plotly.relayout('graph', { width: calculateGraphWidth(), height: calculateGraphHeight() });
            }
        }

        function enforceSingleSelection(groupId, changedId) {
            console.log(`Enforcing single selection in ${groupId} for ${changedId}`);
            const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]`);
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== changedId && checkbox.checked) checkbox.checked = false;
            });
        }

        function filterByConditionRange(data, condition, ranges) {
            if (!ranges.length) return data;
            console.log(`Filtering ${condition} with ranges:`, ranges);
            return data.filter(row => {
                const value = row[condition];
                if (value === undefined || value === null || isNaN(parseFloat(value))) return true;
                const numericValue = parseFloat(value);
                return ranges.some(range => {
                    if (range.endsWith('+')) return numericValue >= parseFloat(range);
                    const [min, max] = range.split('-').map(parseFloat);
                    return numericValue >= min && numericValue <= max;
                });
            });
        }

        function calculateRegression(x, y) {
            // Filter outliers using IQR method
            const pairedData = x.map((xi, i) => ({ x: xi, y: y[i] }));
            const yValues = y.slice().sort((a, b) => a - b);
            const q1 = yValues[Math.floor(yValues.length * 0.25)];
            const q3 = yValues[Math.floor(yValues.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            const filteredData = pairedData.filter(d => d.y >= lowerBound && d.y <= upperBound);
            const filteredX = filteredData.map(d => d.x);
            const filteredY = filteredData.map(d => d.y);

            const n = filteredX.length;
            if (n < 2) return { slope: NaN, intercept: NaN, rSquared: NaN };
            const sumX = filteredX.reduce((a, b) => a + b, 0);
            const sumY = filteredY.reduce((a, b) => a + b, 0);
            const sumXY = filteredX.reduce((sum, xi, i) => sum + xi * filteredY[i], 0);
            const sumXX = filteredX.reduce((sum, xi) => sum + xi * xi, 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const yPred = filteredX.map(xi => slope * xi + intercept);
            const ssTot = filteredY.reduce((sum, yi, i) => sum + Math.pow(yi - sumY / n, 2), 0);
            const ssRes = filteredY.reduce((sum, yi, i) => sum + Math.pow(yi - yPred[i], 2), 0);
            const rSquared = ssTot === 0 ? NaN : 1 - (ssRes / ssTot);
            return { slope, intercept, rSquared };
        }

        function aggregateVariables(data) {
            const depths = [0, 5, 10, 20, 30, 40, 50, 100, 200];
            const zones = ['A', 'B', 'C'];
            return data.map(row => {
                const newRow = { ...row };
                depths.forEach(depth => {
                    const keys = zones.map(zone => `TS_${depth}_${zone}${depth === 0 ? 1 : depth === 5 ? 2 : depth === 10 ? 3 : depth === 20 ? 4 : depth === 30 ? 5 : depth === 40 ? 6 : depth === 50 ? 7 : depth === 100 ? 8 : 9}`);
                    const values = keys.map(k => row[k]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                    newRow[`TS_${depth}`] = values.length > 0 ? values.reduce((sum, v) => sum + parseFloat(v), 0) / values.length : null;
                });
                const taKeys = ['TA_2_0_1', 'TA_2_0_2'];
                const taValues = taKeys.map(k => row[k]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                newRow['TA_2_0'] = taValues.length > 0 ? taValues.reduce((sum, v) => sum + parseFloat(v), 0) / taValues.length : null;
                const rhKeys = ['RH_2_0_1', 'RH_2_0_2'];
                const rhValues = rhKeys.map(k => row[k]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                newRow['RH_2_0'] = rhValues.length > 0 ? rhValues.reduce((sum, v) => sum + parseFloat(v), 0) / rhValues.length : null;
                return newRow;
            });
        }

        function getWeeklyTimestamps(data, start, end) {
            const weeklyData = {};
            data.forEach(row => {
                const date = row.TIMESTAMP;
                if ((!start || date >= start) && (!end || date <= new Date(end.getTime() + 24 * 60 * 60 * 1000 - 1))) {
                    const weekStart = new Date(date);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    const key = weekStart.toISOString().split('T')[0];
                    if (!weeklyData[key]) weeklyData[key] = { TIMESTAMP: weekStart, values: {} };
                    Object.keys(row).forEach(k => {
                        if (k !== 'TIMESTAMP') {
                            weeklyData[key].values[k] = weeklyData[key].values[k] || [];
                            if (row[k] !== null && !isNaN(parseFloat(row[k]))) weeklyData[key].values[k].push(parseFloat(row[k]));
                        }
                    });
                }
            });
            const result = Object.values(weeklyData).map(w => ({
                TIMESTAMP: w.TIMESTAMP,
                ...Object.keys(w.values).reduce((acc, k) => ({
                    ...acc,
                    [k]: w.values[k].length > 0 ? w.values[k].reduce((sum, v) => sum + v, 0) / w.values[k].length : null
                }), {})
            }));
            console.log('Weekly data sample (first 5):', result.slice(0, 5));
            return result;
        }

        function calculateGraphWidth() {
            const graphContainer = document.getElementById('graph-container');
            const width = graphContainer.clientWidth;
            return Math.max(320, width);
        }

        function calculateGraphHeight() {
            const graphContainer = document.getElementById('graph-container');
            const height = graphContainer.clientHeight;
            return Math.max(240, height);
        }

        function toggleLegend() {
            legendVisible = !legendVisible;
            Plotly.relayout('graph', { 
                showlegend: legendVisible,
                'legend.x': legendVisible ? 1 : -9999
            });
            document.getElementById('legend-tab').textContent = legendVisible ? 'Legend' : 'Legend';
        }

        function updateGraph() {
            console.log('Starting updateGraph');
            document.getElementById('graph').innerHTML = '';
            if (!dataLoaded) {
                console.log('Data not loaded yet');
                document.getElementById('graph').innerHTML = 'Please click Analyze to load data';
                return;
            }
            if (typeof Plotly === 'undefined') {
                console.error('Plotly not loaded');
                document.getElementById('graph').innerHTML = 'Plotly library not loaded';
                return;
            }

            const selectedPlots = Array.from(document.querySelectorAll('#plot-menu input:checked')).map(input => parseInt(input.value));
            const independent = Array.from(document.querySelectorAll('#independent-menu input:checked'))[0]?.value || 'Temp_target';
            const dependents = Array.from(document.querySelectorAll('#dependent-menu input:checked')).map(input => input.value);
            const conditionElements = Array.from(document.querySelectorAll('#condition-menu input:checked')).filter(el => el.id.endsWith('_cond'));
            const conditions = conditionElements.map(el => ({
                key: el.value,
                ranges: Array.from(document.querySelectorAll(`#condition-menu input:checked:not([id$="_cond"])[id^="${el.id.split('_cond')[0]}"]`)).map(input => input.value)
            }));
            const chartType = document.querySelector('#chart-type-menu input:checked').value;
            const showFit = document.getElementById('show-fit').checked;

            console.log('Selected plots:', selectedPlots);
            console.log('Independent:', independent);
            console.log('Dependents:', dependents);
            console.log('Conditions:', conditions.map(c => ({ [c.key]: c.ranges })));
            console.log('Chart type:', chartType);

            let workingData = selectedPlots.length > 0 ? allData.filter(row => selectedPlots.includes(row.Plot)) : allData;
            console.log('After plot filter:', workingData.length);
            if (startDate || endDate) {
                console.log('Filtering by time:', startDate?.toISOString().split('T')[0], endDate?.toISOString().split('T')[0]);
                workingData = workingData.filter(row => {
                    const rowDate = row.TIMESTAMP;
                    return (!startDate || rowDate >= startDate) && (!endDate || rowDate <= new Date(endDate.getTime() + 24 * 60 * 60 * 1000 - 1));
                });
                console.log('After time filter:', workingData.length);
            }
            conditions.forEach(({ key, ranges }) => {
                workingData = filterByConditionRange(workingData, key, ranges);
                console.log(`After ${key} filter:`, workingData.length);
            });

            workingData = aggregateVariables(workingData);
            console.log('After variable aggregation:', workingData.length);

            if (independent === 'TIMESTAMP') {
                workingData = getWeeklyTimestamps(workingData, startDate, endDate);
                console.log('After weekly aggregation:', workingData.length);
            }

            console.log('Sample working data (first 5):', workingData.slice(0, 5).map(row => ({
                TIMESTAMP: row.TIMESTAMP.toISOString().split('T')[0],
                Plot: row.Plot,
                [independent]: independent === 'TIMESTAMP' ? row.TIMESTAMP : row[independent],
                ...dependents.reduce((acc, dep) => ({ ...acc, [dep]: row[dep] }), {})
            })));
            
            const traces = [];
            const fitTraces = [];
            dependents.forEach((dep, i) => {
                const xValues = workingData.map(row => independent === 'TIMESTAMP' ? row.TIMESTAMP : row[independent]).filter(v => v !== undefined && v !== null);
                const yValues = workingData.map(row => row[dep]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                console.log(`Trace for ${dep}: x=${xValues.length}, y=${yValues.length}`);
                console.log(`Sample ${independent} (first 5):`, xValues.slice(0, 5));
                console.log(`Sample ${dep} (first 5):`, yValues.slice(0, 5));

                traces.push({
                    x: xValues,
                    y: yValues,
                    mode: chartType === 'scatter' ? 'markers' : chartType === 'line' ? 'lines' : chartType === 'area' ? 'lines' : chartType === 'box' ? 'box' : 'bar',
                    type: chartType === 'scatter' ? 'scattergl' : chartType === 'area' ? 'scattergl' : chartType,
                    name: document.querySelector(`label[for="${dep}"]`)?.textContent || dep,
                    marker: { color: colors[i % colors.length], size: 8 },
                    line: (chartType === 'line' || chartType === 'area') ? { color: colors[i % colors.length], width: 2 } : undefined,
                    fill: chartType === 'area' ? 'tozeroy' : undefined
                });

                if (showFit) {
                    const xNum = xValues.map(x => independent === 'TIMESTAMP' ? x.getTime() : x);
                    const { slope, intercept } = calculateRegression(xNum, yValues);
                    if (!isNaN(slope) && !isNaN(intercept)) {
                        const xFit = independent === 'TIMESTAMP' ? [new Date(Math.min(...xNum)), new Date(Math.max(...xNum))] : [Math.min(...xNum), Math.max(...xNum)];
                        const yFit = xFit.map(x => slope * (independent === 'TIMESTAMP' ? x.getTime() : x) + intercept);
                        fitTraces.push({
                            x: xFit,
                            y: yFit,
                            mode: 'lines',
                            type: 'scattergl',
                            name: `${document.querySelector(`label[for="${dep}"]`)?.textContent || dep} (fit)`,
                            line: { color: colors[i % colors.length], width: 2, dash: 'dash' }
                        });
                    }
                }
            });

            if (!traces.some(trace => trace.x.length > 0 && trace.y.length > 0)) {
                console.log('No plottable data');
                document.getElementById('graph').innerHTML = 'No plottable data for selected variables.';
                return;
            }

            const statsText = dependents.map(dep => {
                const xValues = workingData.map(row => independent === 'TIMESTAMP' ? row.TIMESTAMP.getTime() : row[independent]).filter(v => v !== undefined && v !== null);
                const yValues = workingData.map(row => row[dep]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                if (yValues.length > 0) {
                    const { slope, rSquared } = calculateRegression(xValues, yValues);
                    return `${document.querySelector(`label[for="${dep}"]`)?.textContent || dep}: Slope: ${slope.toFixed(4)}, R²: ${rSquared.toFixed(4)}`;
                }
                return `${dep}: No valid data points`;
            }).join('<br>');
            document.getElementById('stats-content').innerHTML = statsText;

            const timeRangeMs = (endDate || new Date()).getTime() - (startDate || allData[0].TIMESTAMP).getTime();
            const timeUnit = timeRangeMs > 365 * 24 * 60 * 60 * 1000 ? 'month' : timeRangeMs > 30 * 24 * 60 * 60 * 1000 ? 'week' : 'day';

            const xAxisTitle = independent === 'CO2_trmt' ? 'CO₂ Treatment (ppm)' : 
                              independent === 'TIMESTAMP' ? 'Time' : 
                              'Target Temperature (°C)';
            const yAxisTitle = dependents.length === 1 ? document.querySelector(`label[for="${dependents[0]}"]`)?.textContent || 'Measurements' : 'Measurements';

            const annotations = showFit ? dependents.map((dep, i) => {
                const xValues = workingData.map(row => independent === 'TIMESTAMP' ? row.TIMESTAMP.getTime() : row[independent]).filter(v => v !== undefined && v !== null);
                const yValues = workingData.map(row => row[dep]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                if (yValues.length > 0) {
                    const { slope, rSquared } = calculateRegression(xValues, yValues);
                    return {
                        x: 0.5,
                        y: 1 - (i * 0.05),
                        xref: 'paper',
                        yref: 'paper',
                        text: `${document.querySelector(`label[for="${dep}"]`)?.textContent || dep}: Slope: ${slope.toFixed(4)}, R²: ${rSquared.toFixed(4)}`,
                        showarrow: false,
                        font: { color: '#00FF00', family: 'VT323, monospace', size: 12 }
                    };
                }
                return null;
            }).filter(a => a !== null) : [];

            const layout = {
                width: calculateGraphWidth(),
                height: calculateGraphHeight(),
                plot_bgcolor: '#1A1A1A',
                paper_bgcolor: '#1A1A1A',
                font: { color: '#FFFFFF', size: 12 },
                title: {
                    text: `Comparative Biospheromics Dashboard: ${independent === 'CO2_trmt' ? 'CO₂' : independent === 'TIMESTAMP' ? 'Time' : 'Temperature'} vs. Measurements`,
                    font: { size: 16 },
                    x: 0.5,
                    xanchor: 'center',
                    y: 0.95,
                    yanchor: 'top'
                },
                xaxis: {
                    title: { text: xAxisTitle, font: { size: 14 } },
                    gridcolor: '#444',
                    zerolinecolor: '#444',
                    type: independent === 'TIMESTAMP' ? 'date' : 'linear',
                    dtick: independent === 'TIMESTAMP' ? (timeUnit === 'month' ? 'M1' : timeUnit === 'week' ? '604800000' : '86400000') : undefined
                },
                yaxis: {
                    title: { text: yAxisTitle, font: { size: 14 } },
                    gridcolor: '#444',
                    zerolinecolor: '#444',
                    automargin: true
                },
                margin: { t: 80, b: 40, l: 100, r: 40 }, // Increased l, reduced b
                showlegend: legendVisible,
                legend: { x: 1, y: 1, xanchor: 'right', yanchor: 'top', bgcolor: 'rgba(26, 26, 26, 0.8)' },
                annotations: annotations
            };
            console.log('Plotly layout:', JSON.stringify(layout, null, 2));
            console.log('Plotting with Plotly');
            Plotly.newPlot('graph', showFit ? traces.concat(fitTraces) : traces, layout).catch(err => console.error('Plotly error:', err));
        }

        document.getElementById('sidebar-tab').addEventListener('click', toggleSidebar);
        document.getElementById('plot-toggle').addEventListener('click', () => toggleDropdown('plot-menu'));
        document.getElementById('independent-toggle').addEventListener('click', () => toggleDropdown('independent-menu'));
        document.getElementById('dependent-toggle').addEventListener('click', () => toggleDropdown('dependent-menu'));
        document.getElementById('condition-toggle').addEventListener('click', () => toggleDropdown('condition-menu'));
        document.getElementById('time-range-toggle').addEventListener('click', () => toggleDropdown('time-range-menu'));
        document.getElementById('stats-toggle').addEventListener('click', () => toggleDropdown('stats-menu'));
        document.getElementById('chart-type-toggle').addEventListener('click', () => toggleDropdown('chart-type-menu'));
        document.getElementById('analyze-button').addEventListener('click', () => {
            console.log('Analyze button clicked');
            loadData();
        });
        document.getElementById('legend-tab').addEventListener('click', toggleLegend);
        document.getElementById('show-fit').addEventListener('change', updateGraph);

        document.querySelectorAll('#independent-menu input').forEach(input => {
            input.addEventListener('change', () => {
                enforceSingleSelection('independent-menu', input.id);
                document.getElementById('independent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
            });
            if (input.id === 'Temp_target') input.checked = true;
        });

        document.querySelectorAll('#dependent-menu input').forEach(input => {
            input.addEventListener('change', () => {
                document.getElementById('dependent-toggle').textContent = 
                    Array.from(document.querySelectorAll('#dependent-menu input:checked'))
                        .map(input => document.querySelector(`label[for="${input.id}"]`).textContent)
                        .join(', ') || 'Select Dependent';
            });
        });

        document.querySelectorAll('#condition-menu input').forEach(input => {
            input.addEventListener('change', () => {
                if (input.id.endsWith('_cond') && input.checked) {
                    const rangeOptions = document.querySelectorAll(`#condition-menu input:not([id$="_cond"])[id^="${input.id.split('_cond')[0]}"]`);
                    rangeOptions.forEach(option => option.checked = true);
                }
            });
        });

        document.querySelectorAll('#chart-type-menu input').forEach(input => {
            input.addEventListener('change', () => {
                document.getElementById('chart-type-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
            });
        });

        flatpickr('#start-date', {
            dateFormat: 'Y-m-d',
            onChange: (selectedDates) => {
                startDate = selectedDates[0];
                document.getElementById('time-range-toggle').textContent = 
                    `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
            }
        });

        flatpickr('#end-date', {
            dateFormat: 'Y-m-d',
            onChange: (selectedDates) => {
                endDate = selectedDates[0];
                document.getElementById('time-range-toggle').textContent = 
                    `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
            }
        });

        window.addEventListener('resize', () => {
            if (dataLoaded && typeof Plotly !== 'undefined') {
                Plotly.relayout('graph', { 
                    width: calculateGraphWidth(), 
                    height: calculateGraphHeight() 
                });
            }
        });

        console.log('Script loaded, initializing...');
        populatePlotDropdown();
    </script>
</body>
</html>
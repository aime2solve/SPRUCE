<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Biospheromics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Exo+2:wght@700&family=VT323&family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>
    <style>
        @font-face {
            font-family: 'Nasalization';
            src: url('https://raw.githubusercontent.com/aime2solve/SPRUCE/main/Nasalization.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; background-color: #000000; font-family: 'Lato', sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        h1 { color: #00FFFF; text-align: center; padding: 2vh; font-family: 'Nasalization', sans-serif; font-size: calc(16px + 1.5vw); margin: 0; text-shadow: 2px 2px 4px #00CC66, -2px -2px 4px #00CC66, 0 0 10px #00FFFF; animation: glowBreathe 8s cubic-bezier(0.45, 0, 0.55, 1) infinite; flex-shrink: 0; z-index: 11; line-height: 1.5; text-transform: uppercase; }
        @keyframes glowBreathe { 0%, 100% { text-shadow: 2px 2px 4px #00CC66, -2px -2px 4px #00CC66, 0 0 10px #00FFFF; } 25%, 75% { text-shadow: 2px 2px 5px #00CC66, -2px -2px 5px #00CC66, 0 0 12px #00FFFF; } 50% { text-shadow: 2px 2px 4.5px #00CC66, -2px -2px 4.5px #00CC66, 0 0 11px #00FFFF; } }
        .container { display: flex; flex-grow: 1; overflow: hidden; height: calc(100vh - 4vh); position: relative; }
        .sidebar { width: 250px; background: rgba(26, 26, 26, 0.8); border-right: 2px solid #00FFFF; padding: 15px; display: flex; flex-direction: column; gap: 15px; position: absolute; top: 0; left: 0; height: 100%; transition: transform 0.3s ease; z-index: 10; }
        .sidebar.collapsed { transform: translateX(-250px); }
        .sidebar-tab { position: absolute; top: 0; right: -40px; width: 40px; height: 40px; background: rgba(26, 26, 26, 0.8); border: 2px solid #00FFFF; border-left: none; border-radius: 0 10px 10px 0; color: #00FFFF; font-size: 19px; line-height: 36px; text-align: center; cursor: pointer; box-shadow: 0 0 8px #00FFFF; z-index: 11; }
        .sidebar-title { font-family: 'Exo 2', sans-serif; font-size: 26px; color: #DAA520; text-align: center; text-shadow: 0 0 10px #DAA520; line-height: 1.2; margin-top: 0; }
        .sidebar-title span { display: block; font-size: 18px; }
        .button-container { display: flex; align-items: center; width: 100%; position: relative; }
        .button-label { color: #FFFF00; font-size: 13px; margin-right: 10px; width: 100px; text-align: right; padding-left: 10px; }
        .dropdown-toggle, #control-panel-button { background: rgba(26, 26, 26, 0.8); border: 2px solid #00FFFF; border-radius: 10px; color: #00FFFF; font-size: 11px; padding: 4px 8px; width: calc(100% - 120px); text-align: center; cursor: pointer; box-shadow: 0 0 8px #00FFFF; }
        #time-range-toggle { font-size: 10px; white-space: nowrap; }
        .dropdown-menu { position: absolute; top: 100%; left: 110px; width: calc(100% - 120px); max-height: 200px; overflow-y: auto; background: rgba(26, 26, 26, 0.9); border: 2px solid #00FFFF; border-radius: 10px; color: #00FFFF; font-size: 11px; padding: 8px; z-index: 100; display: none; }
        .dropdown-menu.open { display: block; }
        .dropdown-item { display: flex; align-items: center; margin-bottom: 3px; }
        #dependent-menu .dropdown-item label, #independent-menu .dropdown-item label, #plot-number-menu .dropdown-item label { margin-left: 5px; }
        #time-range-menu { padding: 10px; }
        #time-range-menu .dropdown-item { flex-direction: column; align-items: flex-start; margin-bottom: 10px; }
        #time-range-menu input[type="text"] { width: 100%; background: rgba(26, 26, 26, 0.8); border: 1px solid #00FFFF; color: #00FFFF; padding: 4px; margin-top: 5px; font-size: 11px; }
        #stats-menu { color: #00FF00; font-family: 'VT323', monospace; font-size: 15px; }
        #plot-number-menu { width: 300px; left: auto; right: -10px; top: 40px; }
        .graph-container { position: absolute; right: 0; width: calc(100vw - 250px); background-color: #1A1A1A; height: calc(100vh - 4vh); transition: width 0.3s ease, left 0.3s ease; z-index: 1; overflow: hidden; }
        .graph-container.full-width { width: 100vw; left: 0; }
        #graph { width: 100%; height: 100%; min-width: 320px; min-height: 240px; position: relative; }
        .welcome-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00FF00; font-family: 'VT323', monospace; font-size: 20px; text-align: center; text-shadow: 0 0 10px #00FF00; z-index: 2; }
        .welcome-message img { display: block; margin: 0 auto; max-width: 300px; height: auto; }
        .welcome-message hr { border: 1px solid #00FFFF; width: 80%; margin: 10px auto; }
       
        .controls-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(26, 26, 26, 0.7); /* Semi-transparent */
    border: 2px solid #00FFFF;
    border-radius: 10px;
    padding: 15px;
    color: #00FFFF;
    font-size: 13px;
    z-index: 20;
    display: none;
    width: 320px; /* Narrower width */
    max-height: 80vh;
    overflow-y: auto;
}
.controls-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    cursor: move; /* Indicate draggable header */
}
.controls-header h3 {
    margin: 0;
    color: #DAA520;
    font-family: 'Exo 2', sans-serif;
    font-size: 18px;
    flex-grow: 1;
    text-align: left;
}
.close-button {
    display: none; /* Hidden by default */
    width: 30px;
    height: 30px;
    background: rgba(26, 26, 26, 0.8);
    border: 2px solid #00FFFF;
    border-radius: 50%;
    color: #00FFFF;
    font-size: 16px;
    line-height: 26px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 0 5px #00FFFF;
}
.slider-container { margin: 10px 0; position: relative; }
.slider-container label { display: block; margin-bottom: 5px; }
.range-slider { position: relative; width: 100%; height: 5px; background: #444; border-radius: 5px; pointer-events: none; }
.range-track { position: absolute; height: 5px; background: #00FFFF; z-index: 1; }
.range-slider input[type="range"] { position: absolute; width: 100%; height: 5px; top: -5px; background: none; -webkit-appearance: none; pointer-events: none; }
.range-slider input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: #00FFFF; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 0 5px #00FFFF; }
.range-slider input[type="range"]::-webkit-slider-runnable-track { background: transparent; }
.slider-values { display: flex; justify-content: space-between; font-size: 11px; color: #00FF00; margin-top: 5px; pointer-events: none; }

@media (max-width: 768px) {
    .controls-popup { width: 240px; font-size: 11px; }
}
@media (max-width: 480px) {
    .controls-popup { width: 80vw; padding: 10px; }
    .close-button { display: block; }
}
            .sidebar-title { font-size: 18px; }
            .sidebar-title span { font-size: 12px; }
            .button-label { font-size: 10px; width: 70px; }
            .dropdown-toggle, #control-panel-button { font-size: 9px; width: calc(100% - 80px); }
            .dropdown-menu { left: 80px; width: calc(100% - 80px); font-size: 9px; }
            #plot-number-menu { width: 200px; top: 35px; }
            h1 { font-size: calc(12px + 1vw); }
            .mobile-sidebar-button { display: block; }
        }
    </style>
</head>
<body>
    <h1>Comparative Biospheromics Dashboard</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-tab" id="sidebar-tab"><</div>
            <div class="sidebar-title">SPRUCE<br><span>Data Explorer</span></div>

            <div class="button-container">
                <span class="button-label">Control Panel:</span>
                <div id="control-panel-button">Show Control Panel</div>
            </div>

            <div class="button-container">
                <span class="button-label">X-Axis:</span>
                <div class="dropdown-toggle" id="independent-toggle">Time</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="TIMESTAMP" value="TIMESTAMP" checked><label for="TIMESTAMP">Time</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TA_2_0" value="TA_2_0"><label for="TA_2_0">Ambient Temp 2m (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="RH_2_0" value="RH_2_0"><label for="RH_2_0">Relative Humidity 2m (%)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction 10m (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6" value="PREC_6"><label for="PREC_6">Precipitation (mm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_measured" value="CO2_measured"><label for="CO2_measured">Measured CO₂ (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="H2O_measured" value="H2O_measured"><label for="H2O_measured">Measured H₂O (mmol/mol)</label></div>
                </div>
            </div>

            <div class="button-container">
                <span class="button-label">Y-Axis:</span>
                <div class="dropdown-toggle" id="dependent-toggle">Select Dependent</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="TS_0" value="TS_0"><label for="TS_0" style="color: #00FFFF;">Soil Temp 0 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_5" value="TS_5"><label for="TS_5" style="color: #FFFF00;">Soil Temp 5 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_10" value="TS_10"><label for="TS_10" style="color: #FF00FF;">Soil Temp 10 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_20" value="TS_20"><label for="TS_20" style="color: #00FF00;">Soil Temp 20 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_30" value="TS_30"><label for="TS_30" style="color: #FF0000;">Soil Temp 30 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_40" value="TS_40"><label for="TS_40" style="color: #0000FF;">Soil Temp 40 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_50" value="TS_50"><label for="TS_50" style="color: #FFA500;">Soil Temp 50 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_100" value="TS_100"><label for="TS_100" style="color: #800080;">Soil Temp 100 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_200" value="TS_200"><label for="TS_200" style="color: #008080;">Soil Temp 200 cm (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TA_2_0_dep" value="TA_2_0"><label for="TA_2_0_dep" style="color: #FF6347;">Ambient Temp 2m (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="RH_2_0_dep" value="RH_2_0"><label for="RH_2_0_dep" style="color: #4682B4;">Relative Humidity 2m (%)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10_dep" value="WD_10"><label for="WD_10_dep" style="color: #6A5ACD;">Wind Direction 10m (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6_dep" value="PRECC_6"><label for="PREC_6_dep" style="color: #DAA520;">Precipitation (mm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_measured_dep" value="CO2_measured"><label for="CO2_measured_dep" style="color: #FF69B4;">Measured CO₂ (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="H2O_measured_dep" value="H2O_measured"><label for="H2O_measured_dep" style="color: #7FFF00;">Measured H₂O (mmol/mol)</label></div>
                </div>
            </div>

            <div class="button-container">
                <span class="button-label">Time Range:</span>
                <div class="dropdown-toggle" id="time-range-toggle">2015-08-01 - 2025-04-05</div>
                <div class="dropdown-menu" id="time-range-menu">
                    <div class="dropdown-item"><label for="start-date">Start Date:</label><input type="text" id="start-date" value="2015-08-01"></div>
                    <div class="dropdown-item"><label for="end-date">End Date:</label><input type="text" id="end-date" value="2025-04-05"></div>
                </div>
            </div>

            <div class="button-container">
                <span class="button-label">Chart Type:</span>
                <div class="dropdown-toggle" id="chart-type-toggle">Scatter</div>
                <div class="dropdown-menu" id="chart-type-menu">
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="scatter" value="scatter" checked><label for="scatter">Scatter</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="line" value="line"><label for="line">Line</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="bar" value="bar"><label for="bar">Bar</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="area" value="area"><label for="area">Area</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="box" value="box"><label for="box">Box</label></div>
                    <div class="dropdown-item"><input type="radio" name="chart-type" id="anova" value="anova"><label for="anova">ANOVA</label></div>
                </div>
            </div>

            <div class="button-container">
                <span class="button-label">Stats:</span>
                <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                <div class="dropdown-menu" id="stats-menu">
                    <div id="stats-content"></div>
                    <div class="fit-options" id="fit-options">
                        <div class="dropdown-item"><input type="radio" name="fit-type" id="fit-auto" value="auto" checked><label for="fit-auto">Auto (Best Fit)</label></div>
                        <div class="dropdown-item"><input type="radio" name="fit-type" id="fit-linear" value="linear"><label for="fit-linear">Linear</label></div>
                        <div class="dropdown-item"><input type="radio" name="fit-type" id="fit-exponential" value="exponential"><label for="fit-exponential">Exponential</label></div>
                        <div class="dropdown-item"><input type="radio" name="fit-type" id="fit-polynomial" value="polynomial"><label for="fit-polynomial">Polynomial</label></div>
                        <div class="dropdown-item"><input type="radio" name="fit-type" id="fit-logarithmic" value="logarithmic"><label for="fit-logarithmic">Logarithmic</label></div>
                    </div>
                    <div class="dropdown-item"><input type="checkbox" id="show-fit" checked><label for="show-fit">Show Fit</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="show-on-chart"><label for="show-on-chart">Show on Chart</label></div>
                </div>
            </div>
        </div>

        <div class="graph-container" id="graph-container">
            <div id="graph">
                <div class="welcome-message" id="welcome-message">
                    <a href="https://mnspruce.ornl.gov" target="_blank"><img src="./SPRUCE_logo.png" alt="SPRUCE Logo"></a>
                    <hr>An experiment to assess the response of northern peatland ecosystems to increases in temperature and exposures to elevated atmospheric CO₂ concentrations.<hr>Beginning August 2015
                </div>
            </div>
        </div>
    </div>

   <div class="controls-popup" id="control-panel-popup">
    <div class="controls-header" id="controls-header">
        <h3 style="flex-grow: 1; text-align: left;">Control Panel</h3>
        <div class="dropdown-toggle" id="plot-number-toggle" style="width: 80px;">Plot #</div>
        <div class="close-button" id="close-control-panel">×</div>
    </div>
    <div id="control-panel-content"></div>
</div>
<div class="mobile-sidebar-button" id="mobile-sidebar-button">></div>

   <script>
    let allData = [];
    const dataUrl = 'https://raw.githubusercontent.com/aime2solve/SPRUCE/main/spruce_daily_with_co2_h2o.json';
    let startDate = new Date('2015-08-01');
    let endDate = new Date('2025-04-05');
    let dataLoaded = false;
    let legendVisible = true;
    let cachedData = null;
    let graphInitialized = false;
    let statsOpened = false;
    let selectedPlots = [];

    const dependentColors = { /* ... */ };
    const controlRanges = { /* ... */ };
    let currentRanges = JSON.parse(JSON.stringify(controlRanges));
    let depthRange = [0, 200];
    const unitMap = { /* ... */ };
    const plotConditions = { /* ... */ };

    async function loadData() {
        const graphDiv = document.getElementById('graph');
        graphDiv.innerHTML = '<div class="welcome-message" id="welcome-message">Loading data...</div>';
        try {
            const response = await fetch(dataUrl);
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            allData = await response.json();
            allData = allData.map(row => {
                const year = parseInt(row.Year, 10);
                const dfoy = parseFloat(row.DFOY);
                const day = Math.floor(dfoy);
                const fractionalDay = dfoy - day;
                const date = new Date(year, 0);
                date.setDate(day);
                date.setHours(Math.floor(fractionalDay * 24), Math.floor((fractionalDay * 24 % 1) * 60), 0, 0);
                row.TIMESTAMP = date;
                row.Plot = Number(row.Plot);
                return row;
            }).filter(row => !isNaN(row.TIMESTAMP) && row.TIMESTAMP instanceof Date && !isNaN(row.Plot));

            const plotMenu = document.getElementById('plot-number-menu');
            if (plotMenu) {
                plotMenu.innerHTML = Object.entries(plotConditions).map(([plot, cond]) =>
                    `<div class="dropdown-item"><input type="checkbox" id="plot-${plot}" value="${plot}" checked><label for="plot-${plot}">Plot ${plot} (${cond.temp}, ${cond.co2}, ${cond.chamber})</label></div>`
                ).join('');
            } else {
                console.warn('Plot number menu not found in DOM');
            }

            selectedPlots = Object.keys(plotConditions).map(Number);
            document.getElementById('plot-number-toggle').textContent = 'Plot #';

            dataLoaded = true;
            cachedData = aggregateVariables(allData);
            updateGraph();
        } catch (error) {
            console.error('Error loading data:', error);
            graphDiv.innerHTML = '<div class="warning-message">Failed to load data. Check the console for details.</div>';
        }
    }

    function resetGraph() {
        const graphDiv = document.getElementById('graph');
        if (graphInitialized) Plotly.purge(graphDiv);
        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) welcomeMessage.style.display = 'block';
        graphInitialized = false;
    }

    function toggleDropdown(id) {
        const menus = document.querySelectorAll('.dropdown-menu');
        menus.forEach(menu => {
            if (menu.id !== id && menu.style.display === 'block') menu.style.display = 'none';
        });
        const menu = document.getElementById(id);
        if (menu) {
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            console.log(`Toggled dropdown: ${id}, now ${menu.style.display === 'block' ? 'open' : 'closed'}`);
            if (id === 'stats-menu' && menu.style.display === 'block') {
                statsOpened = true;
                updateStatsOptions();
                updateGraph();
            }
        }
    }

    function toggleSidebar() { /* ... */ }
    function enforceSingleSelection(groupId, changedId) { /* ... */ }
    function filterByRanges(data) { /* ... */ }
    function filterByDepthRange(data) { /* ... */ }

    function toggleControlPanel() {
        const popup = document.getElementById('control-panel-popup');
        const button = document.getElementById('control-panel-button');
        const isVisible = popup.style.display === 'block';
        popup.style.display = isVisible ? 'none' : 'block';
        button.textContent = isVisible ? 'Show Control Panel' : 'Hide Control Panel';

        if (!isVisible) {
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            const content = document.getElementById('control-panel-content');
            content.innerHTML = Object.keys(controlRanges).map(key => `
                <div class="slider-container">
                    <label>${controlRanges[key].label}</label>
                    <div class="range-slider">
                        <div class="range-track" id="${key}-track"></div>
                        <input type="range" id="${key}-min" min="${controlRanges[key].min}" max="${controlRanges[key].max}" value="${currentRanges[key].defaultMin}" step="${key === 'Soil_Depth' ? 5 : 0.1}">
                        <input type="range" id="${key}-max" min="${controlRanges[key].min}" max="${controlRanges[key].max}" value="${currentRanges[key].defaultMax}" step="${key === 'Soil_Depth' ? 5 : 0.1}">
                    </div>
                    <div class="slider-values">
                        <span id="${key}-min-value">${currentRanges[key].defaultMin}</span>
                        <span id="${key}-max-value">${currentRanges[key].defaultMax}</span>
                    </div>
                </div>
            `).join('');

            Object.keys(controlRanges).forEach(key => {
                const minSlider = document.getElementById(`${key}-min`);
                const maxSlider = document.getElementById(`${key}-max`);
                const track = document.getElementById(`${key}-track`);
                const minValue = document.getElementById(`${key}-min-value`);
                const maxValue = document.getElementById(`${key}-max-value`);

                function updateTrack() {
                    const min = parseFloat(minSlider.value);
                    const max = parseFloat(maxSlider.value);
                    const minPercent = ((min - controlRanges[key].min) / (controlRanges[key].max - controlRanges[key].min)) * 100;
                    const maxPercent = ((max - controlRanges[key].min) / (controlRanges[key].max - controlRanges[key].min)) * 100;
                    track.style.left = `${minPercent}%`;
                    track.style.width = `${maxPercent - minPercent}%`;
                }

                let isDragging = false;

                minSlider.addEventListener('mousedown', () => isDragging = true);
                maxSlider.addEventListener('mousedown', () => isDragging = true);
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        updateGraph();
                    }
                });
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    let min = parseFloat(minSlider.value);
                    let max = parseFloat(maxSlider.value);
                    if (e.target === minSlider) {
                        min = Math.min(max, parseFloat(minSlider.value));
                        minSlider.value = min;
                        currentRanges[key].defaultMin = min;
                        minValue.textContent = min.toFixed(1);
                        if (key === 'Soil_Depth') depthRange[0] = min;
                    } else if (e.target === maxSlider) {
                        max = Math.max(min, parseFloat(maxSlider.value));
                        maxSlider.value = max;
                        currentRanges[key].defaultMax = max;
                        maxValue.textContent = max.toFixed(1);
                        if (key === 'Soil_Depth') depthRange[1] = max;
                    }
                    updateTrack();
                });

                updateTrack();
            });
        }
    }

    function calculateFit(x, y, fitType) { /* ... */ }
    function calculateStats(xNum, yNum, yPred, type, params) { /* ... */ }
    function calculateANOVA(data, independent, dependent) { /* ... */ }
    function calculateBoxStats(yValues) { /* ... */ }
    function aggregateVariables(data) { /* ... */ }
    function getWeeklyTimestamps(data, start, end) { /* ... */ }
    function calculateGraphWidth() { /* ... */ }
    function calculateGraphHeight() { /* ... */ }
    function filterOutliers(x, y) { /* ... */ }
    function updateStatsOptions() { /* ... */ }

    function updateGraph() {
        const graphDiv = document.getElementById('graph');
        if (!dataLoaded || typeof Plotly === 'undefined') {
            resetGraph();
            return;
        }

        const independent = Array.from(document.querySelectorAll('#independent-menu input:checked'))[0]?.value || null;
        const allDependents = Array.from(document.querySelectorAll('#dependent-menu input:checked')).map(input => input.value);
        const chartType = document.querySelector('#chart-type-menu input:checked').value;
        const fitType = document.querySelector('#fit-options input:checked')?.value || 'auto';
        const showFit = document.getElementById('show-fit').checked;
        const showOnChart = document.getElementById('show-on-chart').checked;

        document.getElementById('independent-toggle').textContent = independent ? document.querySelector(`label[for="${independent}"]`)?.textContent || 'Select Independent' : 'Select Independent';
        document.getElementById('dependent-toggle').innerHTML = allDependents.length ? allDependents.map(dep => `<span style="color: ${dependentColors[dep]}">${document.querySelector(`label[for="${dep}"], label[for="${dep}_dep"]`)?.textContent}</span>`).join('<br>') : 'Select Dependent';

        if (!allDependents.length || !independent) {
            resetGraph();
            return;
        }

        let workingData = filterByRanges(cachedData);
        workingData = filterByDepthRange(workingData);
        workingData = workingData.filter(row => {
            const rowDate = row.TIMESTAMP;
            return (!startDate || rowDate >= startDate) && (!endDate || rowDate <= new Date(endDate.getTime() + 24 * 60 * 60 * 1000 - 1)) &&
                   (selectedPlots.length === 0 || selectedPlots.includes(row.Plot));
        });
        console.log(`Filtered data length: ${workingData.length}, Selected Plots: ${selectedPlots.length ? selectedPlots.join(', ') : 'None'}`);

        if (independent === 'TIMESTAMP' && ['scatter', 'line', 'area'].includes(chartType)) {
            workingData = getWeeklyTimestamps(workingData, startDate, endDate);
        }

        const units = allDependents.map(dep => unitMap[dep]);
        const commonUnit = units.every(u => u === units[0]) ? units[0] : null;
        const dependents = commonUnit ? allDependents.filter(dep => unitMap[dep] === commonUnit) : allDependents;
        if (!dependents.length || !workingData.length) {
            resetGraph();
            console.warn('No valid data after filtering');
            return;
        }

        const traces = [];
        const fitTraces = [];
        let invalidTraces = [];
        const statsText = [];

        // ... (rest of updateGraph logic remains unchanged)

        const welcomeMessage = document.getElementById('welcome-message');
        if (welcomeMessage) welcomeMessage.style.display = 'none';

        if (!graphInitialized) {
            Plotly.newPlot(graphDiv, data, layout, { responsive: true })
                .then(() => {
                    graphInitialized = true;
                    console.log('Graph initialized');
                })
                .catch(err => console.error('Plotly newPlot error:', err));
        } else {
            Plotly.react(graphDiv, data, layout)
                .catch(err => {
                    console.error('Plotly react error:', err);
                    Plotly.newPlot(graphDiv, data, layout, { responsive: true })
                        .then(() => graphInitialized = true)
                        .catch(err => console.error('Fallback newPlot error:', err));
                });
        }
    }

    document.getElementById('close-control-panel').addEventListener('click', () => {
        const popup = document.getElementById('control-panel-popup');
        const button = document.getElementById('control-panel-button');
        popup.style.display = 'none';
        button.textContent = 'Show Control Panel';
    });

    function makeDraggable(element, header) {
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        header.addEventListener('mousedown', startDragging);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDragging);

        function startDragging(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
            if (e.target === header || e.target.parentElement === header) {
                isDragging = true;
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                xOffset = currentX;
                yOffset = currentY;

                const rect = element.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;
                currentX = Math.max(0, Math.min(currentX, maxX));
                currentY = Math.max(0, Math.min(currentY, maxY));

                element.style.transform = 'none';
                element.style.left = currentX + 'px';
                element.style.top = currentY + 'px';
            }
        }

        function stopDragging() {
            isDragging = false;
        }
    }

    const controlPanel = document.getElementById('control-panel-popup');
    const controlHeader = document.getElementById('controls-header');
    makeDraggable(controlPanel, controlHeader);

    document.getElementById('sidebar-tab').addEventListener('click', toggleSidebar);
    document.getElementById('mobile-sidebar-button').addEventListener('click', toggleSidebar);
    document.getElementById('independent-toggle').addEventListener('click', () => toggleDropdown('independent-menu'));
    document.getElementById('dependent-toggle').addEventListener('click', () => toggleDropdown('dependent-menu'));
    document.getElementById('time-range-toggle').addEventListener('click', () => toggleDropdown('time-range-menu'));
    document.getElementById('stats-toggle').addEventListener('click', () => toggleDropdown('stats-menu'));
    document.getElementById('chart-type-toggle').addEventListener('click', () => toggleDropdown('chart-type-menu'));
    document.getElementById('control-panel-button').addEventListener('click', toggleControlPanel);
    document.getElementById('plot-number-toggle').addEventListener('click', () => toggleDropdown('plot-number-menu'));
    document.getElementById('show-fit').addEventListener('change', updateGraph);
    document.getElementById('show-on-chart').addEventListener('change', updateGraph);

    document.querySelectorAll('#independent-menu input').forEach(input => { /* ... */ });
    document.querySelectorAll('#dependent-menu input').forEach(input => { /* ... */ });
    document.querySelectorAll('#chart-type-menu input').forEach(input => { /* ... */ });
    document.querySelectorAll('#fit-options input').forEach(input => { /* ... */ });
    document.querySelectorAll('#plot-number-menu input').forEach(input => { /* ... */ });

    flatpickr('#start-date', { /* ... */ });
    flatpickr('#end-date', { /* ... */ });

    window.addEventListener('resize', () => { /* ... */ });

    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjs/13.2.0/math.min.js';
    script.onload = () => {
        if (typeof math === 'undefined') console.error('math.js failed to initialize');
        loadData();
    };
    script.onerror = () => console.error('Failed to load math.js');
    document.head.appendChild(script);
</script>
</body>
</html>
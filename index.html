<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Biospheromics</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Lato:wght@400;700&family=Merriweather:wght@700&family=Exo+2:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: #000000; font-family: 'Lato', sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        h1 { color: #00FFFF; text-align: center; text-shadow: 0 0 3px #00CC66; padding: 3vh; font-family: 'Orbitron', sans-serif; font-size: calc(18px + 2vw); margin: 0; animation: faintPulse 5s infinite alternate; }
        @keyframes faintPulse { 0% { text-shadow: 0 0 3px #00CC66; } 100% { text-shadow: 0 0 5px #00FFFF; } }
        .container { display: flex; flex-grow: 1; overflow: hidden; }
        .sidebar { width: 250px; background: rgba(26, 26, 26, 0.8); border-right: 2px solid #00FFFF; padding: 15px; display: flex; flex-direction: column; gap: 20px; position: fixed; top: 15vh; height: 85%; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-230px); }
        .sidebar-tab { position: absolute; top: 0; right: -40px; width: 40px; height: 40px; background: rgba(26, 26, 26, 0.8); border: 2px solid #00FFFF; border-left: none; border-radius: 0 10px 10px 0; color: #00FFFF; font-size: 18px; line-height: 36px; text-align: center; cursor: pointer; box-shadow: 0 0 8px #00FFFF; }
        .sidebar-title { font-family: 'Exo 2', sans-serif; font-size: 24px; color: #DAA520; text-align: center; text-shadow: 0 0 10px #DAA520; line-height: 1.2; }
        .sidebar-title span { display: block; font-size: 16px; }
        .button-container { display: flex; align-items: center; width: 100%; position: relative; }
        .button-label { color: #FFFF00; font-size: 12px; margin-right: 10px; width: 100px; text-align: right; padding-left: 10px; }
        .dropdown-toggle, #analyze-button { background: rgba(26, 26, 26, 0.8); border: 2px solid #00FFFF; border-radius: 10px; color: #00FFFF; font-size: 10px; padding: 4px 8px; width: calc(100% - 120px); text-align: left; cursor: pointer; box-shadow: 0 0 8px #00FFFF; }
        #analyze-button { text-align: center; }
        .dropdown-menu { position: absolute; top: 100%; left: 110px; width: calc(100% - 120px); max-height: 0; overflow-y: auto; background: rgba(26, 26, 26, 0.9); border: 2px solid #00FFFF; border-radius: 10px; color: #00FFFF; font-size: 10px; padding: 8px; transition: max-height 0.5s ease; visibility: hidden; z-index: 10; }
        .dropdown-menu.open { max-height: 600px; visibility: visible; }
        .dropdown-item { display: flex; align-items: center; margin-bottom: 3px; }
        #condition-menu .dropdown-item { flex-direction: column; align-items: flex-start; margin-bottom: 8px; }
        #condition-menu .range-options { margin-left: 20px; margin-top: 5px; }
        #condition-menu .range-options .dropdown-item { margin-bottom: 3px; }
        #time-range-menu { padding: 10px; }
        #time-range-menu .dropdown-item { flex-direction: column; align-items: flex-start; margin-bottom: 10px; }
        #time-range-menu input[type="text"] { width: 100%; background: rgba(26, 26, 26, 0.8); border: 1px solid #00FFFF; color: #00FFFF; padding: 4px; margin-top: 5px; font-size: 10px; }
        .stats-panel { position: absolute; top: 100%; left: 110px; width: calc(100% - 120px); max-height: 0; background: rgba(26, 26, 26, 0.95); border: 2px solid #00FFFF; border-radius: 10px; color: #00FF00; font-size: 10px; padding: 8px; overflow: hidden; transition: max-height 0.5s ease; visibility: hidden; }
        .stats-panel.open { max-height: 200px; visibility: visible; }
        .graph-container { flex-grow: 1; margin-left: 250px; background-color: #1A1A1A; height: 98%; transition: margin-left 0.3s ease; }
        .graph-container.full-width { margin-left: 0; }
        #graph { width: 90%; height: 99%; margin: 0.5% auto; }
        #dependent-menu label[for="TS_0__A1"] { color: #FF5555; }
        #dependent-menu label[for="TS_-5__A2"] { color: #55FF55; }
        #dependent-menu label[for="TS_-10__A3"] { color: #5555FF; }
        #dependent-menu label[for="TS_-20__A4"] { color: #FFFF55; }
        #dependent-menu label[for="TS_-100__A8"] { color: #FF55FF; }
        #dependent-menu label[for="TS_Hummock_A1"] { color: #55FFFF; }
        #dependent-menu label[for="CO2_amb"] { color: #FFAA55; }
        #dependent-menu label[for="TA_2_0_2"] { color: #AA55FF; }
        #dependent-menu label[for="SM_-10__A3"] { color: #55AAFF; }
        #dependent-menu label[for="RH_2_0_1"] { color: #FF55AA; }
    </style>
</head>
<body>
    <h1>Comparative Biospheromics</h1>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-tab" id="sidebar-tab">></div>
            <div class="sidebar-title">SPRUCE<br><span>Data Explorer</span></div>
            <div class="button-container">
                <span class="button-label">Plot:</span>
                <div class="dropdown-toggle" id="plot-toggle">Select Plots</div>
                <div class="dropdown-menu" id="plot-menu"></div>
            </div>
            <div class="button-container">
                <span class="button-label">Independent:</span>
                <div class="dropdown-toggle" id="independent-toggle">Target Temperature (°C)</div>
                <div class="dropdown-menu" id="independent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="Temp_target" value="Temp_target"><label for="Temp_target">Target Temperature (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_trmt" value="CO2_trmt"><label for="CO2_trmt">CO₂ Treatment (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WS_10" value="WS_10"><label for="WS_10">Wind Speed (m/s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="WD_10" value="WD_10"><label for="WD_10">Wind Direction (°)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PAR_2" value="PAR_2"><label for="PAR_2">PAR (µmol/m²s)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="PREC_6" value="PREC_6"><label for="PREC_6">Precipitation (mm)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Dependent:</span>
                <div class="dropdown-toggle" id="dependent-toggle">Soil Temp 0 cm (A1, °C)</div>
                <div class="dropdown-menu" id="dependent-menu">
                    <div class="dropdown-item"><input type="checkbox" id="TS_0__A1" value="TS_0__A1"><label for="TS_0__A1">Soil Temp 0 cm (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-5__A2" value="TS_-5__A2"><label for="TS_-5__A2">Soil Temp -5 cm (A2, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-10__A3" value="TS_-10__A3"><label for="TS_-10__A3">Soil Temp -10 cm (A3, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-20__A4" value="TS_-20__A4"><label for="TS_-20__A4">Soil Temp -20 cm (A4, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_-100__A8" value="TS_-100__A8"><label for="TS_-100__A8">Soil Temp -100 cm (A8, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TS_Hummock_A1" value="TS_Hummock_A1"><label for="TS_Hummock_A1">Hummock Temp (A1, °C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="CO2_amb" value="CO2_amb"><label for="CO2_amb">Ambient CO₂ (ppm)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="TA_2_0_2" value="TA_2_0_2"><label for="TA_2_0_2">Air Temp 2m (°C)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="SM_-10__A3" value="SM_-10__A3"><label for="SM_-10__A3">Soil Moisture -10 cm (%)</label></div>
                    <div class="dropdown-item"><input type="checkbox" id="RH_2_0_1" value="RH_2_0_1"><label for="RH_2_0_1">Relative Humidity 2m (%)</label></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Conditions:</span>
                <div class="dropdown-toggle" id="condition-toggle">Select Conditions</div>
                <div class="dropdown-menu" id="condition-menu">
                    <div class="dropdown-item">
                        <input type="checkbox" id="WS_10_cond" value="WS_10"><label for="WS_10_cond">Wind Speed (m/s)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="WS_10_0_2" value="0-2"><label for="WS_10_0_2">0-2</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WS_10_2_5" value="2-5"><label for="WS_10_2_5">2-5</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WS_10_5_plus" value="5+"><label for="WS_10_5_plus">5+</label></div>
                        </div>
                    </div>
                    <div class="dropdown-item">
                        <input type="checkbox" id="WD_10_cond" value="WD_10"><label for="WD_10_cond">Wind Direction (°)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="WD_10_0_90" value="0-90"><label for="WD_10_0_90">0-90</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WD_10_90_180" value="90-180"><label for="WD_10_90_180">90-180</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="WD_10_180_360" value="180-360"><label for="WD_10_180_360">180-360</label></div>
                        </div>
                    </div>
                    <div class="dropdown-item">
                        <input type="checkbox" id="PAR_2_cond" value="PAR_2"><label for="PAR_2_cond">PAR (µmol/m²s)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="PAR_2_0_50" value="0-50"><label for="PAR_2_0_50">0-50</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PAR_2_50_100" value="50-100"><label for="PAR_2_50_100">50-100</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PAR_2_100_plus" value="100+"><label for="PAR_2_100_plus">100+</label></div>
                        </div>
                    </div>
                    <div class="dropdown-item">
                        <input type="checkbox" id="PREC_6_cond" value="PREC_6"><label for="PREC_6_cond">Precipitation (mm)</label>
                        <div class="range-options">
                            <div class="dropdown-item"><input type="checkbox" id="PREC_6_0_1" value="0-1"><label for="PREC_6_0_1">0-1</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PREC_6_1_5" value="1-5"><label for="PREC_6_1_5">1-5</label></div>
                            <div class="dropdown-item"><input type="checkbox" id="PREC_6_5_plus" value="5+"><label for="PREC_6_5_plus">5+</label></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Time Range:</span>
                <div class="dropdown-toggle" id="time-range-toggle">Select Time Range</div>
                <div class="dropdown-menu" id="time-range-menu">
                    <div class="dropdown-item">
                        <label for="start-date">Start Date:</label>
                        <input type="text" id="start-date" placeholder="YYYY-MM-DD">
                    </div>
                    <div class="dropdown-item">
                        <label for="end-date">End Date:</label>
                        <input type="text" id="end-date" placeholder="YYYY-MM-DD">
                    </div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Stats:</span>
                <div class="dropdown-toggle" id="stats-toggle">Show Stats</div>
                <div class="stats-panel" id="stats-panel">
                    <div id="stats-content"></div>
                </div>
            </div>
            <div class="button-container">
                <span class="button-label">Analyze:</span>
                <div id="analyze-button">Analyze</div>
            </div>
        </div>
        <div class="graph-container" id="graph-container">
            <div id="graph"></div>
        </div>
    </div>

    <script>
        let allData = [];
        const plots = Array.from({ length: 21 }, (_, i) => i + 1);
        const dataUrl = 'https://raw.githubusercontent.com/aime2solve/SPRUCE/main/spruce_daily.json';
        let startDate = null;
        let endDate = null;
        let dataLoaded = false;

        document.getElementById('graph').innerHTML = '';
        const welcome = document.createElement('div');
        welcome.textContent = 'Welcome to Comparative Biospheromics!\nChoose variables and conditions to analyze';
        welcome.style.cssText = 'color: #FFFFFF; font-family: Orbitron, sans-serif; font-size: 16px; text-align: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 0 10px #00CC66';
        document.getElementById('graph').appendChild(welcome);

        function populatePlotDropdown() {
            const plotMenu = document.getElementById('plot-menu');
            plotMenu.innerHTML = '';
            plots.forEach(plot => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `plot-${plot}`;
                input.value = plot;
                input.checked = true;
                input.addEventListener('change', () => console.log(`Plot ${plot} toggled`));
                const label = document.createElement('label');
                label.htmlFor = `plot-${plot}`;
                label.textContent = `Plot ${plot}`;
                div.appendChild(input);
                div.appendChild(label);
                plotMenu.appendChild(div);
            });
        }

        async function loadData() {
            if (dataLoaded) return;
            try {
                console.log('Fetching data from:', dataUrl);
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                allData = await response.json();
                console.log(`Loaded ${allData.length} rows`);
                allData.forEach(row => {
                    row.TIMESTAMP = new Date(row.TIMESTAMP);
                });
                console.log('Sample data (first row):', allData[0]);
                console.log('Data date range:', 
                    'Min:', new Date(Math.min(...allData.map(row => row.TIMESTAMP))).toISOString().split('T')[0],
                    'Max:', new Date(Math.max(...allData.map(row => row.TIMESTAMP))).toISOString().split('T')[0]);
                console.log('WS_10 sample (first 10):', allData.map(row => row.WS_10).slice(0, 10));
                console.log('WD_10 sample (first 10):', allData.map(row => row.WD_10).slice(0, 10));
                console.log('PAR_2 sample (first 10):', allData.map(row => row.PAR_2).slice(0, 10));
                console.log('PREC_6 sample (first 10):', allData.map(row => row.PREC_6).slice(0, 10));
                console.log('CO2_trmt sample (first 10):', allData.map(row => row.CO2_trmt).slice(0, 10));
                console.log('TS_0__A1 sample (first 10):', allData.map(row => row.TS_0__A1).slice(0, 10));
                console.log('TS_-10__A3 sample (first 10):', allData.map(row => row.TS_-10__A3).slice(0, 10));
                console.log('TS_-100__A8 sample (first 10):', allData.map(row => row.TS_-100__A8).slice(0, 10));
                dataLoaded = true;
                updateGraph();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('graph').innerHTML = 'Error loading data';
            }
        }

        function toggleDropdown(id) {
            console.log(`Toggling dropdown: ${id}`);
            const menu = document.getElementById(id);
            if (menu) menu.classList.toggle('open');
            else console.error(`Dropdown menu not found: ${id}`);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const graphContainer = document.getElementById('graph-container');
            const tab = document.getElementById('sidebar-tab');
            sidebar.classList.toggle('collapsed');
            graphContainer.classList.toggle('full-width');
            tab.textContent = sidebar.classList.contains('collapsed') ? '<' : '>';
            if (dataLoaded && typeof Plotly !== 'undefined' && Plotly.relayout) {
                Plotly.relayout('graph', {
                    width: document.getElementById('graph').clientWidth,
                    height: document.getElementById('graph').clientHeight
                });
            }
        }

        function enforceSingleSelection(groupId, changedId) {
            const checkboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]`);
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== changedId && checkbox.checked) checkbox.checked = false;
            });
        }

        function filterByConditionRange(data, condition, ranges) {
            if (!ranges.length) return data;
            console.log(`Filtering ${condition} with ranges:`, ranges);
            console.log(`Sample ${condition} values (first 5):`, data.slice(0, 5).map(row => row[condition]));
            return data.filter(row => {
                const value = row[condition];
                if (value === undefined || value === null || isNaN(parseFloat(value))) {
                    console.log(`Row with ${condition} = ${value} included (missing/invalid)`);
                    return true;
                }
                const numericValue = parseFloat(value);
                const passes = ranges.some(range => {
                    if (range.endsWith('+')) {
                        const min = parseFloat(range);
                        return numericValue >= min;
                    }
                    const [min, max] = range.split('-').map(parseFloat);
                    return numericValue >= min && numericValue <= max;
                });
                return passes;
            });
        }

        function updateGraph() {
            document.getElementById('graph').innerHTML = '';
            if (!dataLoaded) {
                document.getElementById('graph').innerHTML = 'Please click Analyze to load data';
                return;
            }

            console.log('Checking Plotly availability:', typeof Plotly);
            if (typeof Plotly === 'undefined' || typeof Plotly.newPlot !== 'function') {
                console.error('Plotly not available - library issue');
                document.getElementById('graph').innerHTML = 'Plotly library not loaded';
                return;
            }

            const selectedPlots = Array.from(document.querySelectorAll('#plot-menu input:checked')).map(input => parseInt(input.value));
            const independent = Array.from(document.querySelectorAll('#independent-menu input:checked'))[0]?.value || 'Temp_target';
            const dependents = Array.from(document.querySelectorAll('#dependent-menu input:checked')).map(input => input.value);
            const conditionElements = Array.from(document.querySelectorAll('#condition-menu input:checked')).filter(el => el.id.endsWith('_cond'));
            const conditions = conditionElements.map(el => ({
                key: el.value,
                ranges: Array.from(document.querySelectorAll(`#condition-menu input:checked:not([id$="_cond"])[id^="${el.id.split('_cond')[0]}"]`)).map(input => input.value)
            }));

            let workingData = allData.filter(row => selectedPlots.includes(row.Plot));
            console.log('After plot filter:', workingData.length);
            if (startDate || endDate) {
                console.log('Time range:', startDate?.toISOString().split('T')[0], endDate?.toISOString().split('T')[0]);
                workingData = workingData.filter(row => {
                    const rowDate = row.TIMESTAMP;
                    return (!startDate || rowDate >= startDate) && (!endDate || rowDate <= endDate);
                });
                console.log('After time filter:', workingData.length);
            }
            conditions.forEach(({ key, ranges }) => {
                const preLength = workingData.length;
                workingData = filterByConditionRange(workingData, key, ranges);
                console.log(`After ${key} filter (${ranges.join(', ')}): ${preLength} -> ${workingData.length}`);
            });

            console.log(`Plotting ${workingData.length} rows with ${independent} vs [${dependents.join(', ')}]`);
            console.log('Sample working data (first row):', workingData[0] || 'No data after filtering');

            if (workingData.length === 0) {
                document.getElementById('graph').innerHTML = 'No data matches the selected filters. Try adjusting conditions or time range.';
                return;
            }

            console.log(`${independent} sample (first 5):`, workingData.slice(0, 5).map(row => row[independent]));
            dependents.forEach(dep => {
                console.log(`${dep} sample (first 5):`, workingData.slice(0, 5).map(row => row[dep]));
            });

            const colorMap = {
                'TS_0__A1': '#FF5555',
                'TS_-5__A2': '#55FF55',
                'TS_-10__A3': '#5555FF',
                'TS_-20__A4': '#FFFF55',
                'TS_-100__A8': '#FF55FF',
                'TS_Hummock_A1': '#55FFFF',
                'CO2_amb': '#FFAA55',
                'TA_2_0_2': '#AA55FF',
                'SM_-10__A3': '#55AAFF',
                'RH_2_0_1': '#FF55AA'
            };

            const traces = dependents.map(dep => {
                const xValues = workingData.map(row => row[independent]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                const yValues = workingData.map(row => row[dep]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                console.log(`Trace for ${dep}: xValues length = ${xValues.length}, yValues length = ${yValues.length}`);
                return {
                    x: xValues,
                    y: yValues,
                    mode: 'markers',
                    type: 'scattergl',
                    marker: { color: colorMap[dep], size: 6 },
                    name: document.querySelector(`label[for="${dep}"]`)?.textContent || dep,
                    hoverinfo: 'text',
                    text: workingData.map(row => `Plot ${row.Plot}<br>${independent}: ${row[independent]}<br>${dep}: ${row[dep]}`).filter((_, i) => xValues[i] !== undefined && yValues[i] !== undefined)
                };
            });

            const hasValidData = traces.some(trace => trace.x.length > 0 && trace.y.length > 0);
            if (!hasValidData) {
                document.getElementById('graph').innerHTML = 'No plottable data for selected variables. Check variable availability.';
                return;
            }

            const layout = {
                width: document.getElementById('graph').clientWidth,
                height: document.getElementById('graph').clientHeight,
                plot_bgcolor: '#1A1A1A',
                paper_bgcolor: '#1A1A1A',
                font: { color: '#FFFFFF', family: 'Lato, sans-serif' },
                xaxis: {
                    title: document.querySelector(`label[for="${independent}"]`)?.textContent || independent,
                    gridcolor: '#444',
                    zerolinecolor: '#444'
                },
                yaxis: {
                    title: 'Dependent Variables',
                    gridcolor: '#444',
                    zerolinecolor: '#444'
                },
                margin: { t: 20, b: 60, l: 60, r: 20 },
                showlegend: true
            };

            Plotly.newPlot('graph', traces, layout);

            const statsText = dependents.map(dep => {
                const allY = workingData.map(row => row[dep]).filter(v => v !== undefined && v !== null && !isNaN(parseFloat(v)));
                return allY.length > 0 ? 
                    `<span style="color: ${colorMap[dep]}">${document.querySelector(`label[for="${dep}"]`)?.textContent || dep}</span>: ` +
                    `Mean: ${(allY.reduce((sum, val) => sum + val, 0) / allY.length).toFixed(2)}, ` +
                    `Min: ${Math.min(...allY).toFixed(2)}, Max: ${Math.max(...allY).toFixed(2)}, Points: ${allY.length}` :
                    `${dep}: No valid data points`;
            }).join('<br>');
            document.getElementById('stats-content').innerHTML = statsText;
        }

        document.getElementById('sidebar-tab').addEventListener('click', toggleSidebar);
        document.getElementById('plot-toggle').addEventListener('click', () => toggleDropdown('plot-menu'));
        document.getElementById('independent-toggle').addEventListener('click', () => toggleDropdown('independent-menu'));
        document.getElementById('dependent-toggle').addEventListener('click', () => toggleDropdown('dependent-menu'));
        document.getElementById('condition-toggle').addEventListener('click', () => toggleDropdown('condition-menu'));
        document.getElementById('time-range-toggle').addEventListener('click', () => toggleDropdown('time-range-menu'));
        document.getElementById('stats-toggle').addEventListener('click', () => {
            console.log('Stats toggle clicked');
            const statsPanel = document.getElementById('stats-panel');
            statsPanel.classList.toggle('open');
            document.getElementById('stats-toggle').textContent = statsPanel.classList.contains('open') ? 'Hide Stats' : 'Show Stats';
        });
        document.getElementById('analyze-button').addEventListener('click', () => {
            console.log('Analyze button clicked');
            loadData();
        });

        document.querySelectorAll('#independent-menu input').forEach(input => {
            input.addEventListener('change', () => {
                enforceSingleSelection('independent-menu', input.id);
                document.getElementById('independent-toggle').textContent = document.querySelector(`label[for="${input.id}"]`).textContent;
            });
            if (input.id === 'Temp_target') input.checked = true;
        });

        document.querySelectorAll('#dependent-menu input').forEach(input => {
            input.addEventListener('change', () => {
                document.getElementById('dependent-toggle').textContent = 
                    Array.from(document.querySelectorAll('#dependent-menu input:checked'))
                        .map(input => document.querySelector(`label[for="${input.id}"]`).textContent)
                        .join(', ') || 'Select Dependent';
            });
            if (input.id === 'TS_0__A1') input.checked = true;
        });

        document.querySelectorAll('#condition-menu input').forEach(input => {
            input.addEventListener('change', () => {
                console.log(`Condition ${input.value} toggled`);
                if (input.id.endsWith('_cond') && input.checked) {
                    const rangeOptions = document.querySelectorAll(`#condition-menu input:not([id$="_cond"])[id^="${input.id.split('_cond')[0]}"]`);
                    rangeOptions.forEach(option => option.checked = true);
                }
            });
        });

        flatpickr('#start-date', {
            dateFormat: 'Y-m-d',
            onChange: (selectedDates) => {
                startDate = selectedDates[0];
                document.getElementById('time-range-toggle').textContent = 
                    `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
            }
        });

        flatpickr('#end-date', {
            dateFormat: 'Y-m-d',
            onChange: (selectedDates) => {
                endDate = selectedDates[0];
                document.getElementById('time-range-toggle').textContent = 
                    `${startDate ? startDate.toISOString().split('T')[0] : 'Start'} - ${endDate ? endDate.toISOString().split('T')[0] : 'End'}`;
            }
        });

        populatePlotDropdown();
    </script>
</body>
</html>